<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>UFO Sightings Explorer</title>
  <!-- Vega libs -->
  <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
  <style>
    :root{--bg:#0b0c10;--card:#11131a;--muted:#8a90a6;--text:#e7eaf6;--accent:#7aa2ff}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
    header{display:grid;gap:8px;margin:16px 0 24px}
    header h1{margin:0;font-size:28px;letter-spacing:.2px}
    header p{margin:0;color:var(--muted)}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media (min-width: 900px){.grid{grid-template-columns:1.1fr .9fr}}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:16px;box-shadow:0 6px 24px rgba(0,0,0,.25)}
    .card h2{margin:0 0 8px;font-size:18px}
    .controls{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
    .control{display:flex;gap:8px;align-items:center;color:var(--muted)}
    select,input[type="range"]{background:#0f1220;color:var(--text);border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:6px 10px}
    .small{font-size:12px;color:var(--muted)}
    footer{margin:24px 0;color:var(--muted)}
    a{color:var(--accent);text-decoration:none}
    a:hover{text-decoration:underline}
    .meta{display:flex;gap:16px;flex-wrap:wrap;margin-top:8px}
    .viz{min-height:320px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>UFO Sightings Explorer</h1>
      <p>Interactive views built from <code>scrubbed.csv</code>-derived datasets (monthly trend, city hotspots, shapes, and daily rhythm). Drop this file and all CSVs in the same folder (e.g., GitHub Pages repository) and open.</p>
      <div class="controls card" id="controls">
        <div class="control">
          <label for="shapeSel">Shape</label>
          <select id="shapeSel">
            <option>All</option>
            <option>light</option>
            <option>circle</option>
            <option>sphere</option>
            <option>disk</option>
            <option>triangle</option>
            <option>fireball</option>
            <option>formation</option>
            <option>unknown</option>
            <option>other</option>
          </select>
        </div>
        <div class="control" style="gap:6px;min-width:240px">
          <label for="yearMin">Year</label>
          <input type="range" id="yearMin" min="1900" max="2025" value="1960"/>
          <span class="small" id="yearMinOut">1960</span>
          <span class="small">–</span>
          <input type="range" id="yearMax" min="1900" max="2025" value="2015"/>
          <span class="small" id="yearMaxOut">2015</span>
        </div>
      </div>
    </header>

    <section class="grid">
      <div class="card">
        <h2>Global hotspots by city</h2>
        <div id="map" class="viz"></div>
        <p class="small">Each dot is a city with at least one report. Size & color encode number of reports. Tooltip shows location and total.</p>
      </div>
      <div class="card">
        <h2>Monthly sightings</h2>
        <div id="monthly" class="viz"></div>
        <p class="small">Counts aggregated to the first day of each month. Use the Shape and Year controls to filter.</p>
      </div>
    </section>

    <section class="grid" style="margin-top:16px">
      <div class="card">
        <h2>Shapes (overall + filter aware)</h2>
        <div id="shapes" class="viz"></div>
      </div>
      <div class="card">
        <h2>Daily rhythm (hour × weekday)</h2>
        <div id="hourly" class="viz"></div>
      </div>
    </section>

    <footer>
      <div class="meta">
        <div>Data: NUFORC (scrubbed), derived CSVs: <code>ufo_monthly.csv</code>, <code>ufo_cities.csv</code>, <code>ufo_shape.csv</code>, <code>ufo_hourly.csv</code>, <code>ufo_year.csv</code>, <code>ufo_day.csv</code>.</div>
        <div>Author: Your Name • Date: <span id="today"></span></div>
        <div>Tools: Vega-Lite v5 + vega-embed.</div>
      </div>
    </footer>
  </div>

  <script>
    // Utility: format today
    document.getElementById('today').textContent = new Date().toISOString().slice(0,10);

    // Read controls
    const shapeSel = document.getElementById('shapeSel');
    const yearMin = document.getElementById('yearMin');
    const yearMax = document.getElementById('yearMax');
    const yearMinOut = document.getElementById('yearMinOut');
    const yearMaxOut = document.getElementById('yearMaxOut');
    function syncYearLabels(){
      if(+yearMin.value > +yearMax.value){ yearMin.value = yearMax.value; }
      yearMinOut.textContent = yearMin.value;
      yearMaxOut.textContent = yearMax.value;
    }
    yearMin.addEventListener('input', ()=>{ syncYearLabels(); renderAll(); });
    yearMax.addEventListener('input', ()=>{ syncYearLabels(); renderAll(); });
    shapeSel.addEventListener('change', renderAll);
    syncYearLabels();

    // Common filter transform
    function filtersFor(datasetAlias){
      return [
        {"calculate": "toNumber(year(datum.datetime ? datum.datetime : datum.month ? datum.month : datum._dt))", "as": "_yr"},
        {"filter": `datum._yr >= ${yearMin.value} && datum._yr <= ${yearMax.value}`},
        {"calculate": "datum.shape ? lower(datum.shape) : ''", "as": "_shape"},
        {"filter": shapeSel.value === 'All' ? "true" : `datum._shape == '${shapeSel.value}'`}
      ];
    }

    async function renderMap(){
      const spec = {
        $schema: 'https://vega.github.io/schema/vega-lite/v5.json',
        width: 600, height: 360,
        data: {url: 'ufo_cities.csv'},
        transform: [
          ...filtersFor('cities')
        ],
        projection: {type: 'equalEarth'},
        mark: {type: 'circle', tooltip: true, opacity: 0.8, stroke: '#11131a', strokeWidth: 0.5},
        encoding: {
          longitude: {field: 'longitude', type: 'quantitative'},
          latitude: {field: 'latitude', type: 'quantitative'},
          size: {field: 'count', type: 'quantitative', legend: {title: 'Reports'}, scale: {type: 'sqrt', range: [10, 800]}},
          color: {field: 'count', type: 'quantitative', legend: {title: 'Reports'}},
          tooltip: [
            {field: 'city', title: 'City'},
            {field: 'state', title: 'State'},
            {field: 'country', title: 'Country'},
            {field: 'count', title: 'Total reports', type: 'quantitative'}
          ]
        }
      };
      await vegaEmbed('#map', spec, {actions:false});
    }

    async function renderMonthly(){
      const spec = {
        $schema: 'https://vega.github.io/schema/vega-lite/v5.json',
        width: 560, height: 320,
        data: {url: 'ufo_monthly.csv'},
        transform: [
          ...filtersFor('monthly')
        ],
        layer: [
          {
            mark: {type:'area', line:true, opacity:0.25},
            encoding: {
              x: {field:'month', type:'temporal', title:'Month'},
              y: {field:'count', type:'quantitative', title:'Sightings'},
              tooltip: [{field:'month', type:'temporal'},{field:'count', type:'quantitative'}]
            }
          },
          {
            mark: {type:'rule'},
            encoding: {
              x: {field:'month', type:'temporal'},
              y: {aggregate:'mean', field:'count'},
              color: {value:'#888'},
              size: {value:1}
            }
          }
        ]
      };
      await vegaEmbed('#monthly', spec, {actions:false});
    }

    async function renderShapes(){
      // Filter-aware: we will load cities to recompute shape counts client-side for consistency
      const spec = {
        $schema: 'https://vega.github.io/schema/vega-lite/v5.json',
        width: 560, height: 320,
        data: {url: 'ufo_cities.csv'},
        transform: [
          ...filtersFor('cities'),
          {aggregate: [{op:'sum', field:'count', as:'count'}], groupby:['shape']},
          {calculate: 'lower(datum.shape)', as: 'shape_lc'}
        ],
        mark: {type:'bar', tooltip:true},
        encoding: {
          x: {field:'count', type:'quantitative', title:'Reports'},
          y: {field:'shape_lc', type:'nominal', sort:'-x', title:'Shape'},
          tooltip: [
            {field:'shape_lc', title:'Shape'},
            {field:'count', type:'quantitative'}
          ]
        }
      };
      await vegaEmbed('#shapes', spec, {actions:false});
    }

    async function renderHourly(){
      const spec = {
        $schema: 'https://vega.github.io/schema/vega-lite/v5.json',
        width: 560, height: 320,
        data: {url: 'ufo_hourly.csv'},
        transform: [
          // Expect columns: weekday (0-6 or Mon..Sun), hour (0-23), count
          {calculate: "toNumber(datum.hour)", as: "h"},
          {calculate: "datum.weekday", as: "w"},
          {calculate: "datum.count == null ? 0 : toNumber(datum.count)", as: "c"}
        ],
        mark: 'rect',
        encoding: {
          x: {field:'h', type:'ordinal', title:'Hour', sort:'ascending'},
          y: {field:'w', type:'ordinal', title:'Weekday'},
          color: {field:'c', type:'quantitative', title:'Reports'},
          tooltip: [
            {field:'w', title:'Weekday'},
            {field:'h', title:'Hour'},
            {field:'c', title:'Reports', type:'quantitative'}
          ]
        }
      };
      await vegaEmbed('#hourly', spec, {actions:false});
    }

    async function renderAll(){
      await Promise.all([renderMap(), renderMonthly(), renderShapes(), renderHourly()]);
    }

    renderAll();
  </script>
</body>
</html>
