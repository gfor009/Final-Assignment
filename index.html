<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>UFO Sightings Explorer — USA Focus (Vega-Lite)</title>
  <meta name="description" content="USA-focused UFO visualisation: top cities map, hourly pattern, monthly trend, and shape composition." />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;600;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">

  <!-- Vega libs -->
  <script src="https://unpkg.com/vega@5"></script>
  <script src="https://unpkg.com/vega-lite@5"></script>
  <script src="https://unpkg.com/vega-embed@6"></script>

  <style>
    :root{ --bg:#0f172a; --panel:#111827; --ink:#e5e7eb; --muted:#9ca3af; --brand:#38bdf8; --accent:#a78bfa; }
    html,body{ margin:0; height:100%; background:radial-gradient(1200px 800px at 10% -10%, #1f2937 0%, var(--bg) 40%); color:var(--ink);
      font-family:"Space Grotesk",system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif; line-height:1.6; }
    .container{ max-width:1280px; margin-inline:auto; padding:28px; }
    header.site{ position:sticky; top:0; z-index:1000; backdrop-filter: blur(8px); background:color-mix(in oklab,var(--bg), transparent 40%); border-bottom:1px solid #1f2937; }
    header .bar{ display:flex; gap:16px; align-items:center; justify-content:space-between; padding:12px 24px; }
    .brand{ font-family:"Playfair Display",serif; font-weight:700; letter-spacing:.2px }
    .brand .pill{ display:inline-block; padding:.25rem .6rem; border:1px solid #334155; border-radius:999px; color:var(--muted); font-size:.85rem; margin-left:.5rem }
    nav a{ color:var(--muted); text-decoration:none; margin-left:16px; font-size:.95rem } nav a:hover{ color:var(--ink) }
    .hero{ display:grid; grid-template-columns:1.3fr .7fr; gap:28px; align-items:end; padding:32px 0 8px }
    .hero h1{ font:700 44px/1.12 "Playfair Display",serif; letter-spacing:.2px; margin:0 0 8px; color:#fff }
    .hero p{ color:var(--muted); margin:10px 0 0; max-width:68ch; font-size:1.02rem }
    .tag{ display:inline-block; background:#0b1220; border:1px solid #1f2937; border-radius:999px; padding:.35rem .7rem; font-size:.8rem; color:var(--brand) }
    .grid{ display:grid; grid-template-columns:1fr 1fr; gap:24px; margin-top:24px }
    .card{ background:linear-gradient(180deg,#101827,#0b1220); border:1px solid #1f2937; border-radius:18px; box-shadow:0 10px 40px rgba(0,0,0,.45); overflow:hidden }
    .card header{ display:flex; justify-content:space-between; align-items:center; padding:14px 18px; border-bottom:1px solid #1f2937 }
    .card header h2{ font:600 18px/1.2 "Space Grotesk",system-ui; margin:0; color:#fff; letter-spacing:.2px }
    .card header .small{ color:var(--muted); font-size:.85rem }
    .card .body{ padding:18px 18px 8px }
    .vis{ min-height:380px }
    .kpis{ display:grid; grid-template-columns:repeat(4,1fr); gap:10px; margin-top:10px }
    .kpi{ background:#0b1220; border:1px solid #1f2937; border-radius:12px; padding:10px 12px }
    .kpi .label{ color:var(--muted); font-size:.75rem } .kpi .value{ font-weight:700; font-size:1.2rem }
    .notes{ margin:24px 0 } details{ background:#0b1220; border:1px solid #1f2937; border-radius:12px; padding:10px 14px }
    summary{ cursor:pointer; color:var(--ink); font-weight:600 } .meta{ color:var(--muted); font-size:.9rem }
    footer{ margin:24px 0 60px; color:var(--muted); font-size:.85rem }
    code{ background:#0b1220; border:1px solid #1f2937; border-radius:6px; padding:2px 6px } a{ color:var(--brand) }
    .chart-note{ margin:8px 18px 18px; color:#cbd5e1; font-size:.95rem }
    #map .card{ grid-column:1/-1 } /* full-width map */
    @media (max-width: 880px){ .hero{ grid-template-columns:1fr } .grid{ grid-template-columns:1fr } }
  </style>
</head>
<body>
  <header class="site">
    <div class="bar container">
      <div class="brand">UFO Sightings Explorer <span class="pill">Vega-Lite · USA Focus</span></div>
      <nav>
        <a href="#map">Map</a>
        <a href="#time">Time</a>
        <a href="#meta">Data & Credits</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <section class="hero">
      <div>
        <div class="tag">UFO dataset · cleaned + aggregated</div>
        <h1>Where and when do UFO sightings cluster in the USA?</h1>
        <p>Four coordinated views summarise patterns in the data: a symbol map of top cities, a radial hourly rhythm, a monthly trend, and a yearly shape composition. Visual marks and channels are consistent; colour and figure-ground establish a clear hierarchy; annotations and short notes guide interpretation.</p>
      </div>
      <div class="kpis">
        <div class="kpi"><div class="label">Peak month count</div><div id="kpi1" class="value">—</div></div>
        <div class="kpi"><div class="label">Months covered</div><div id="kpi2" class="value">—</div></div>
        <div class="kpi"><div class="label">Peak month</div><div id="kpi3" class="value">—</div></div>
        <div class="kpi"><div class="label">Total sightings</div><div id="kpi4" class="value">—</div></div>
      </div>
    </section>

    <section id="map" class="grid">
      <article class="card">
        <header>
          <h2>Top US cities (symbol size = sightings)</h2>
          <span class="small">Projection: Albers USA · Hover to highlight</span>
        </header>
        <div id="symbolVis" class="body vis"></div>
        <p class="chart-note">Clusters concentrate along major corridors and coastal metros; a handful of large bubbles indicate outsized reporting relative to neighbouring cities.</p>
      </article>
    </section>

    <section class="grid" id="time">
      <article class="card">
        <header>
          <h2>Sightings by hour (radial)</h2>
          <span class="small">Donut arcs · 00–23h</span>
        </header>
        <div id="hourVis" class="body vis"></div>
        <p class="chart-note">Late evening (20:00–24:00) dominates; daytime reports are comparatively rare.</p>
      </article>

      <article class="card">
        <header>
          <h2>Monthly trend of sightings</h2>
          <span class="small">Line with points · Hover for values</span>
        </header>
        <div id="trendVis" class="body vis"></div>
        <p class="chart-note">A mid-year rise suggests seasonality—warmer, clearer months align with more sightings.</p>
      </article>

      <article class="card">
        <header>
          <h2>Shape composition by year</h2>
          <span class="small">Normalised stacked bars (top 6 + Other)</span>
        </header>
        <div id="stackVis" class="body vis"></div>
        <p class="chart-note">“Light” and “circle” remain dominant; rarer shapes persist at low but steady shares.</p>
      </article>
    </section>

    <section id="meta" class="notes">
      <details open>
        <summary>Data, authorship & credits</summary>
        <ul class="meta">
          <li><strong>Author:</strong> Your Name</li>
          <li><strong>Date:</strong> 21 Oct 2025</li>
          <li><strong>Data files:</strong> <code>data/ufo_cities_latlon.csv</code>, <code>data/ufo_hourly.csv</code>, <code>data/ufo_monthly.csv</code>, <code>data/ufo_shape.csv</code></li>
          <li><strong>Tools:</strong> Vega-Lite 5, custom HTML/CSS</li>
          <li><strong>Licenses:</strong> Visuals CC BY 4.0; Code MIT</li>
        </ul>
      </details>
    </section>

    <footer>Built with <code>Vega-Lite 5</code>. Place CSVs in <code>/data</code> next to this file and hard-refresh.</footer>
  </main>

  <!-- Point these at YOUR files (they already match your repo) -->
  <script>
    const DATA = {
      cities:  "data/ufo_cities_latlon.csv",
      hour:    "data/ufo_hourly.csv",
      monthly: "data/ufo_monthly.csv",
      shapes:  "data/ufo_shape.csv"
    };
  </script>

  <!-- Vega-Lite specs (fixed expressions: no ??) -->
  <script>
    /* 1) USA symbol map — robust header mapping (no ??) + longitude normalisation */
    const symbolSpec = {
      $schema:'https://vega.github.io/schema/vega-lite/v5.json',
      width: 1160, height: 420,
      projection: { type:'albersUsa' },
      layer: [
        {
          data:{ url:'https://vega.github.io/vega-datasets/data/world-110m.json',
                 format:{ type:'topojson', feature:'countries' } },
          transform:[ { filter: 'datum.id == 840' } ],
          mark:{ type:'geoshape', fill:'#0b1220', stroke:'#1f2937' }
        },
        {
          data:{ url: DATA.cities },
          transform:[
            { calculate: "toNumber(datum.latitude || datum.lat || datum.Latitude || datum.Lat)", as: "LAT_raw" },
            { calculate: "toNumber(datum.longitude || datum.lon || datum.lng || datum.Longitude || datum.Lon || datum.long)", as: "LON_raw" },
            { calculate: "toNumber(datum.count || datum.sightings || datum.value || datum.total)", as: "VAL" },
            { calculate: "(datum.city || datum.City || 'Unknown')", as: "CITY" },
            { calculate: "(datum.state || datum.State || datum.region || datum.Region || datum.country || datum.Country || '')", as: "STATE" },
            // normalise 0..360 → -180..180 and rescue obvious swaps
            { calculate: "datum.LON_raw > 180 ? datum.LON_raw - 360 : datum.LON_raw", as:"LON_norm" },
            { calculate: "abs(datum.LON_norm) < 25 && abs(datum.LAT_raw) > 25 ? datum.LON_norm : datum.LAT_raw", as:"LAT2" },
            { calculate: "abs(datum.LON_norm) < 25 && abs(datum.LAT_raw) > 25 ? datum.LAT_raw : datum.LON_norm", as:"LON2" },
            { filter: "isValid(datum.LAT2) && isValid(datum.LON2) && isValid(datum.VAL)" },
            // keep only continental USA to avoid stray points
            { filter: "datum.LON2 >= -130 && datum.LON2 <= -60 && datum.LAT2 >= 22 && datum.LAT2 <= 50" }
          ],
          mark:{ type:'circle', opacity:0.95, stroke:'#0b1220', strokeWidth:0.6 },
          encoding:{
            longitude:{ field:'LON2', type:'quantitative' },
            latitude:{ field:'LAT2', type:'quantitative' },
            size:{ field:'VAL', type:'quantitative', title:'Sightings', scale:{ range:[30,1600] } },
            color:{
              field:'CITY', type:'nominal', title:'City',
              scale:{ range:["#22c55e","#06b6d4","#a78bfa","#f59e0b","#ef4444","#14b8a6","#eab308","#f97316","#10b981","#60a5fa","#f472b6","#38bdf8"] },
              legend:{ orient:'bottom', direction:'horizontal', columns:6, labelLimit:220 }
            },
            tooltip:[
              {field:'CITY', title:'City'}, {field:'STATE', title:'State/Region'},
              {field:'VAL', type:'quantitative', title:'Sightings'},
              {field:'LAT2', title:'lat'}, {field:'LON2', title:'lon'}
            ]
          }
        }
      ],
      config:{ background:null }
    };

    /* 2) Hour radial — expects hour,count */
    const hourSpec = {
      $schema:'https://vega.github.io/schema/vega-lite/v5.json',
      width:600, height:380,
      data:{ url: DATA.hour },
      transform:[{calculate:'format(datum.hour, "02")', as:'hlabel'}],
      mark:{type:'arc', innerRadius:90, stroke:'#0b1220'},
      encoding:{
        theta:{field:'count', type:'quantitative', stack:true},
        color:{ field:'hlabel', type:'nominal', scale:{scheme:{name:'set3', count:24}},
                legend:{title:'Hour (00–23)', orient:'bottom', columns:6, labelLimit:160} },
        tooltip:[{field:'hour', title:'Hour (0–23)'},{field:'count', type:'quantitative'}]
      },
      config:{legend:{orient:'bottom'}}
    };

    /* 3) Monthly trend — accepts month OR date (any case), and count/value/total/sightings */
    const trendSpec = {
      $schema:'https://vega.github.io/schema/vega-lite/v5.json',
      width:600, height:280,
      data:{ url: DATA.monthly },
      transform:[
        { calculate:"toDate(datum.month || datum.Month || datum.date || datum.Date)", as:"MONTH" },
        { calculate:"toNumber(datum.count || datum.Count || datum.value || datum.total || datum.sightings)", as:"CNT" },
        { filter:"isDate(datum.MONTH) && isFinite(datum.CNT)" }
      ],
      mark:{type:'line', point:true},
      encoding:{
        x:{field:'MONTH', type:'temporal', title:'Month'},
        y:{field:'CNT', type:'quantitative', title:'Sightings'},
        color:{value:'#38bdf8'},
        tooltip:[{field:'MONTH', type:'temporal', title:'Month'},{field:'CNT', type:'quantitative', title:'Count'}]
      }
    };

    /* 4) Shapes by year — accepts share OR count */
    const stackSpec = {
      $schema:'https://vega.github.io/schema/vega-lite/v5.json',
      width:600, height:380,
      data: { url: DATA.shapes },
      transform:[
        { calculate:"toNumber(datum.year || datum.Year)", as:"YEAR" },
        { calculate:"toNumber(datum.share || datum.Share)", as:"SHARE_raw" },
        { calculate:"toNumber(datum.count || datum.Count || datum.value || datum.total)", as:"COUNT_raw" },
        { window:[{op:"sum", field:"COUNT_raw", as:"year_total"}], frame:[null,null], groupby:["YEAR"] },
        { calculate:"isFinite(datum.SHARE_raw) ? datum.SHARE_raw : datum.COUNT_raw / datum.year_total", as:"SHARE" },
        { filter:"isFinite(datum.YEAR) && isFinite(datum.SHARE)" }
      ],
      mark:{type:'bar'},
      encoding:{
        x:{field:'YEAR', type:'ordinal', title:'Year'},
        y:{field:'SHARE', type:'quantitative', stack:'normalize', title:'Shape share'},
        color:{ field:'shape', type:'nominal', title:'UFO shape', scale:{scheme:'set2'},
                legend:{orient:'bottom', columns:4, labelLimit:220} },
        tooltip:[{field:'YEAR', title:'Year'},{field:'shape'},{field:'SHARE', type:'quantitative', title:'Share'}]
      }
    };

    // Render all
    vegaEmbed('#symbolVis', symbolSpec, {actions:false}).catch(e=>console.error('Map render error:', e));
    vegaEmbed('#hourVis', hourSpec,   {actions:false}).catch(e=>console.error('Hour chart error:', e));
    vegaEmbed('#trendVis', trendSpec, {actions:false}).catch(e=>console.error('Trend chart error:', e));
    vegaEmbed('#stackVis', stackSpec, {actions:false}).catch(e=>console.error('Stacked chart error:', e));

    // KPI loader — accepts month/date + count/value/total/sightings
    async function loadKpis(){
      try{
        const res = await fetch(DATA.monthly);
        if(!res.ok){ console.error('KPI CSV missing:', res.status, res.statusText); return; }
        const text = (await res.text()).trim();
        const rows = text.split(/\r?\n/); if(rows.length<2){ console.error('KPI CSV has no rows'); return; }
        const header = rows.shift().split(',');
        const findIdx = names => names.map(n=>header.indexOf(n)).find(i=>i>=0);
        const iMonth = findIdx(['month','Month','date','Date']);
        const iCount = findIdx(['count','Count','value','total','sightings']);
        if(iMonth==null || iCount==null){ console.error('KPI: need a month/date column and a count/value/total/sightings column'); return; }
        const data = rows.map(r=>{ const c=r.split(','); return {month:new Date(c[iMonth]), count:+c[iCount]}; })
                         .filter(d=>!isNaN(d.month.getTime()) && isFinite(d.count));
        if(!data.length){ console.error('KPI: no valid rows after parsing'); return; }
        const total = data.reduce((a,d)=>a+d.count,0);
        const max = Math.max(...data.map(d=>d.count));
        const peak = data.reduce((a,b)=> (b.count>a.count? b : a));
        document.getElementById('kpi1').textContent = max;
        document.getElementById('kpi2').textContent = data.length + ' months';
        document.getElementById('kpi3').textContent = peak.month.toISOString().slice(0,7);
        document.getElementById('kpi4').textContent = total;
      }catch(e){
        console.error('KPI load failed:', e);
      }
    }
    loadKpis();
  </script>
</body>
</html>
