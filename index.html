<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>UFO Sightings in America — Where, When, and What We See</title>

<!-- Vega / Vega-Lite -->
<script src="https://unpkg.com/vega@5"></script>
<script src="https://unpkg.com/vega-lite@5"></script>
<script src="https://unpkg.com/vega-embed@6"></script>

<!-- Typography -->
<link href="https://fonts.googleapis.com/css2?family=Oxanium:wght@600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#0b1120;      /* page */
    --panel:#0f172a;   /* card */
    --grid:#1f2937;    /* dividers / chart grids */
    --ink:#e5e7eb;     /* main text */
    --muted:#94a3b8;   /* secondary text */
    --accent:#38bdf8;  /* highlight */
    --accent-soft:#9dd6ff;

    --gap-1:12px; --gap-2:16px; --gap-3:24px; --gap-4:32px; --gap-5:48px;
    --radius:16px;
    --container:1200px; /* desktop friendly width */
  }

  html, body { height:100% }
  body{
    margin:0; background:var(--bg); color:var(--ink);
    font: 15px/1.6 Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
  }

  .container{ max-width:var(--container); margin:auto; padding:var(--gap-4) var(--gap-3) }

  header.hero{ margin:0 0 var(--gap-4) }
  header.hero h1{ margin:0 0 6px; font:700 28px/1.15 Oxanium, sans-serif; letter-spacing:.2px; }
  header.hero p{ margin:0; color:var(--muted); max-width:78ch }

  /* KPI strip – 3 items (Total, Peak year, Top city) */
  .kpis{ display:grid; grid-template-columns:repeat(3,1fr); gap:12px; margin:18px 0 8px }
  .kpi{
    background:var(--panel); border:1px solid var(--grid); border-radius:14px;
    padding:14px 16px; display:flex; flex-direction:column; gap:4px;
  }
  .kpi-number{ font-size:28px; line-height:1; font-weight:800; letter-spacing:.3px }
  .kpi-label{ font-size:12px; opacity:.85 }

  /* Grid */
  .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:var(--gap-3) }
  .wide{ grid-column:1 / -1 }

  /* Cards */
  .card{
    background:var(--panel); border:1px solid var(--grid); border-radius:var(--radius); padding:var(--gap-3);
  }
  .card h2{ margin:0 0 var(--gap-2); font:600 20px/1.25 Oxanium, sans-serif }

  .viz{ min-height:340px }
  .caption{ margin:.5rem 0 0; color:var(--muted) }

  footer.meta{
    margin:var(--gap-5) 0 0; color:var(--muted);
    border-top:1px solid var(--grid); padding-top:var(--gap-3); font-size:13px;
  }

  /* Vega-Lite on dark background */
  .vega-embed .vega-legend text,
  .vega-embed .leg-title { fill:var(--ink) !important }
  .vega-embed .role-axis-label, .vega-embed .role-axis-title { fill:var(--ink) !important }
  .vega-embed .role-axis-grid, .vega-embed .mark-rule { stroke:var(--grid) !important }

  @media (max-width: 1040px){
    .grid{ grid-template-columns:1fr }
  }
</style>
</head>

<body>
<div class="container">
  <header class="hero">
    <h1>UFO Sightings in America — Where, When, and What We See</h1>
    <p id="intro">
      Step into a visual journey through America’s UFO obsession. Using thousands of real reports from the National UFO Reporting Center, this data story maps where and when sightings happened, what shapes people claimed to see, and the hours they looked to the skies. From glowing lights over cities to mysterious waves of sightings across decades, this visualisation uncovers how curiosity, culture, and imagination have shaped the nation’s view of the unknown.
    </p>
  </header>

  <!-- KPI STRIP (3 items) -->
  <div class="kpis">
    <div class="kpi"><div class="kpi-number" id="kpi-total">—</div><div class="kpi-label">Total U.S. reports</div></div>
    <div class="kpi"><div class="kpi-number" id="kpi-peak">—</div><div class="kpi-label">Peak year (reports)</div></div>
    <div class="kpi"><div class="kpi-number" id="kpi-topcity">—</div><div class="kpi-label">Top city (reports)</div></div>
  </div>

  <section class="grid">

    <!-- WHERE: State choropleth -->
    <article class="card wide">
      <h2>Where are reports concentrated? (by state)</h2>
      <div id="chor" class="viz" aria-label="Choropleth of total reports by U.S. state"></div>
      <p id="chor-desc" class="caption"></p>
    </article>

    <!-- WHERE (detail): City hotspots (white basemap) -->
    <article class="card wide">
      <h2>City hotspots</h2>
      <div id="citiesmap" class="viz" aria-label="Bubble map of top-reporting cities"></div>
      <p id="citiesmap-desc" class="caption"></p>
    </article>

    <!-- WHEN: Hour-of-day radial -->
    <article class="card">
      <h2>What time do the UFO visit Earth?</h2>
      <div id="hourly" class="viz" aria-label="Radial bar chart of reports by hour"></div>
      <p class="caption">Most UFO reports light up the timeline right after sunset, peaking between 6 PM and 11 PM, when the sky is dark but still alive with human activity. As the night deepens, the sightings slowly fade, tapering off toward dawn. This pattern makes sense, people are more likely to be outside or looking up during the early evening hours, and the dark sky makes unusual lights easier to spot. It’s a reminder that sometimes, when the world slows down and the stars come out, our imaginations start to roam a little further too..</p>
    </article>

    <!-- WHAT: Top 10 cities (ranking) -->
    <article class="card">
      <h2>Top 10 cities for UFO reports</h2>
      <div id="cities" class="viz" aria-label="Bar ranking of top 10 cities"></div>
      <p id="cities-desc" class="caption"></p>
    </article>

    <!-- WHAT: Shapes (all shapes as a single 100% stacked bar) -->
    <article class="card">
      <h2>What do people report?</h2>
      <div id="shapes" class="viz" aria-label="Stacked 100% bar for all reported shapes"></div>
      <p id="shapes-desc" class="caption">All reported shapes shown as a single stacked bar (100% scale). Hover to see counts and share.</p>
    </article>

    <!-- WHEN: Yearly focus + context (interactive) -->
    <article class="card">
      <h2>Yearly trend (interactive focus + context)</h2>
      <div id="yearly" class="viz" aria-label="Yearly series with 5-year average and brush"></div>
      <p id="yearly-desc" class="caption"></p>
    </article>

  </section>

  <footer class="meta">
    <strong>Data:</strong> NUFORC “scrubbed.csv” + derived aggregates. <strong>Scope:</strong> U.S. only.
    <strong>Author:</strong> Gina Ford • <strong>Date:</strong> <span id="today"></span> •
    <strong>Tools:</strong> Vega-Lite 5, GitHub Pages.
    <br><strong>Notes:</strong> Outliers capped where noted; coordinates cleaned; legends/axes harmonised for consistent figure–ground.
  </footer>
</div>
<script>document.getElementById('today').textContent = new Date().toLocaleDateString();</script>

<script>
/* ---------------- PATHS & HELPERS ---------------- */
const PATHS = {
  raw:     ["data/scrubbed.csv","scrubbed.csv","https://gfor009.github.io/FIT3179/scrubbed.csv"],
  citiesLatLon: ["data/ufo_cities_latlon.csv","ufo_cities_latlon.csv"],
  cities:  ["data/ufo_cities.csv","ufo_cities.csv"],
  shapes:  ["data/ufo_shape.csv","ufo_shape.csv"],
  hourly:  ["data/ufo_hourly.csv","ufo_hourly.csv"],
  yearly:  ["data/ufo_year.csv","ufo_year.csv"]
};

async function fetchFirst(paths){
  let lastErr;
  for (const p of paths){
    try{
      const r = await fetch(p + "?v=" + Date.now());
      if(!r.ok) throw new Error(r.status + " " + r.statusText);
      return {url:p, text: await r.text()};
    }catch(e){ lastErr = e; }
  }
  throw lastErr || new Error("All paths failed");
}
function smartInt(s){
  const t = String(s ?? '').trim();
  if (/^\d{1,3}([.,\s]\d{3})+$/.test(t)) return Number(t.replace(/[.,\s]/g,''));
  return Number(t.replace(/[,\s]/g,''));
}
function smartDeg(s){
  const t = String(s ?? "").trim();
  const direct = Number(t.replace(',', '.'));
  if (isFinite(direct)) return direct;
  const neg = t.startsWith('-') ? -1 : 1;
  const digits = t.replace(/[^0-9]/g, '');
  if (!digits) return NaN;
  const scale = Math.pow(10, Math.max(7, digits.length - 2));
  return neg * (Number(digits) / scale);
}

/* ---------------- KPIs (Total, Peak year, Top city) ---------------- */
async function renderKPIs(){
  // helper csv parse
  const parseCSV = (text) => {
    const first = (text.split(/\r?\n/)[0]||'');
    const delim = first.includes('\t') ? '\t' : (first.includes(';') ? ';' : ',');
    const rows = text.trim().split(/\r?\n/).filter(Boolean).map(r=>r.split(delim));
    const head = (rows.shift()||[]).map(h=>h.trim().toLowerCase());
    return {head, rows};
  };

  let totalUS = 0;
  let peakYear = {year:'—', count:0};
  let topCity = {label:'—', count:0};

  try{
    // From raw: total + peak year
    const {text} = await fetchFirst(PATHS.raw);
    const {head, rows} = parseCSV(text);
    const iCountry = head.indexOf('country');
    const iDT      = [head.indexOf('datetime'), head.indexOf('date_time'), head.indexOf('date'),
                      head.indexOf('occurred'), head.indexOf('sighted_at')].find(i=>i>=0);
    const byYear = new Map();

    for (const r of rows){
      if (iCountry>=0 && (r[iCountry]||'').trim().toLowerCase()!=='us') continue;
      totalUS++;
      if (iDT>=0){
        const m = String(r[iDT]||'').match(/(\d{4})/);
        if (m){ const y=+m[1]; byYear.set(y, (byYear.get(y)||0)+1); }
      }
    }
    if (byYear.size){
      const arr = [...byYear.entries()].map(([year,count])=>({year,count})).sort((a,b)=>b.count-a.count);
      peakYear = arr[0];
    }
  }catch(e){ console.warn('KPI (raw) failed:', e); }

  try{
    // From cities: top city
    const {text} = await fetchFirst(PATHS.citiesLatLon);
    const {head, rows} = ((t)=>{
      const f=(t.split(/\r?\n/)[0]||''); const d=f.includes('\t')?'\t':(f.includes(';')?';':',');
      const r=t.trim().split(/\r?\n/).filter(Boolean).map(x=>x.split(d)); const h=(r.shift()||[]).map(s=>s.trim().toLowerCase());
      return {head:h, rows:r};
    })(text);
    const iCity = head.indexOf('city');
    const iState = Math.max(head.indexOf('state'), head.indexOf('region'));
    const iCountry = head.indexOf('country');
    const iCnt = Math.max(head.indexOf('count'), head.indexOf('sightings'), head.indexOf('total'), head.indexOf('value'));

    const agg = new Map();
    for (const r of rows){
      if (iCountry>=0 && (r[iCountry]||'').trim().toLowerCase()!=='us') continue;
      const city  = (r[iCity]||'').trim(); const state = (r[iState]||'').trim(); const cnt = smartInt(r[iCnt]);
      if (!city || !Number.isFinite(cnt)) continue;
      const key = `${city}__${state}`;
      agg.set(key, (agg.get(key)||0) + cnt);
    }
    if (agg.size){
      const [key,count] = [...agg.entries()].sort((a,b)=>b[1]-a[1])[0];
      const [c,s] = key.split('__');
      topCity = {label:`${c}, ${s}`, count};
    }
  }catch(e){ console.warn('KPI (cities) failed:', e); }

  const fmt = new Intl.NumberFormat('en-US').format;
  document.getElementById('kpi-total').textContent = fmt(totalUS);
  document.getElementById('kpi-peak').textContent = (peakYear.year!=='—') ? `${peakYear.year} (${fmt(peakYear.count)})` : '—';
  document.getElementById('kpi-topcity').textContent = topCity.count ? `${topCity.label} (${fmt(topCity.count)})` : '—';
}

/* ---------------- A) STATE CHOROPLETH ---------------- */
async function renderStateChoropleth(){
  try{
    const topo = { url:'https://vega.github.io/vega-datasets/data/us-10m.json',
                   format:{ type:'topojson', feature:'states' } };

    // FIPS map
    const FIPS = [["AL",1],["AK",2],["AZ",4],["AR",5],["CA",6],["CO",8],["CT",9],["DE",10],["DC",11],
      ["FL",12],["GA",13],["HI",15],["ID",16],["IL",17],["IN",18],["IA",19],["KS",20],["KY",21],["LA",22],
      ["ME",23],["MD",24],["MA",25],["MI",26],["MN",27],["MS",28],["MO",29],["MT",30],["NE",31],["NV",32],
      ["NH",33],["NJ",34],["NM",35],["NY",36],["NC",37],["ND",38],["OH",39],["OK",40],["OR",41],["PA",42],
      ["RI",44],["SC",45],["SD",46],["TN",47],["TX",48],["UT",49],["VT",50],["VA",51],["WA",53],["WV",54],
      ["WI",55],["WY",56]];
    const fipsMap = new Map(FIPS);

    // Build counts from raw
    const {text} = await fetchFirst(PATHS.raw);
    const first = (text.split(/\r?\n/)[0]||''); const delim = first.includes(';')?';':',';
    const rows = text.trim().split(/\r?\n/).filter(Boolean).map(r=>r.split(delim));
    const head = rows.shift().map(h=>h.trim().toLowerCase());
    const iCountry = head.indexOf('country');
    const iState = Math.max(head.indexOf('state'), head.indexOf('state/province'));
    const byState = new Map();
    for (const r of rows){
      if (iCountry>=0 && (r[iCountry]||'').trim().toLowerCase()!=='us') continue;
      const abbr = (r[iState]||'').trim().toUpperCase();
      if (!fipsMap.has(abbr)) continue;
      byState.set(abbr, (byState.get(abbr)||0) + 1);
    }
    const counts = [];
    for (const [abbr,n] of byState) counts.push({id:fipsMap.get(abbr), abbr, count:n});

    const fmt = new Intl.NumberFormat('en-US').format;
    const sorted = counts.slice().sort((a,b)=>b.count-a.count);
    const top = sorted.slice(0,3).map(d=>`${d.abbr} (${fmt(d.count)})`).join(', ');
    const bottom = sorted.slice(-3).map(d=>`${d.abbr} (${fmt(d.count)})`).join(', ');
    const total = counts.reduce((s,d)=>s+d.count,0);
    const descEl = document.getElementById('chor-desc');
    if (descEl){
      descEl.textContent = `Each state is shaded based on the total number of UFO sightings reported across the U.S., a staggering ${fmt(total)} in total. Unsurprisingly, California is the highest with ${top}, reports, followed by Washington (3,651) and Florida (3,644), all known for their clear skies and busy skies alike. On the other end of the spectrum, Delaware (153), North Dakota (120), and Washington D.C. (6) have seen far fewer mysterious lights. The map paints a fascinating picture of how geography, population, and perhaps a little imagination influence where people are most likely to spot something “unidentified” in the night sky. Lowest: ${bottom}.`;
    }

    const spec = {
      $schema:'https://vega.github.io/schema/vega-lite/v5.json',
      width:1180, height:420,
      data: topo,
      transform:[{ lookup:'id', from:{ data:{ values:counts }, key:'id', fields:['count','abbr'] } }],
      mark:{ type:'geoshape', stroke:'#98a0ab', strokeWidth:0.7 },
      encoding:{
        color:{ field:'count', type:'quantitative', title:'Total sightings', scale:{ scheme:'blues' },
                legend:{ orient:'right', gradientLength:240, tickCount:6, format:',d',
                         titleColor:'#e5e7eb', labelColor:'#e5e7eb' } },
        tooltip:[ {field:'abbr', title:'State'}, {field:'count', type:'quantitative', title:'Sightings', format:',d'} ]
      },
      projection:{ type:'albersUsa' },
      config:{ background:null }
    };
    await vegaEmbed('#chor', spec, {actions:false});
  }catch(e){ console.error('Choropleth error:', e); }
}

/* ---------------- B) CITY BUBBLE MAP (white basemap) ---------------- */
async function renderMapFromCities(){
  try{
    const topo = { url:'https://vega.github.io/vega-datasets/data/us-10m.json',
                   format:{ type:'topojson', feature:'states' } };

    const {text} = await fetchFirst(PATHS.citiesLatLon);
    const first = (text.split(/\r?\n/)[0]||''); const delim = first.includes(';') ? ';' : ',';
    const rows = text.trim().split(/\r?\n/).filter(Boolean).map(r=>r.split(delim));
    const head = rows.shift().map(h=>h.trim().toLowerCase());
    const pick = (...names)=> names.map(n=>head.indexOf(n)).find(i=>i>=0);
    const iCity = pick('city');
    const iState = pick('state','region');
    const iCountry = pick('country');
    const iLat = pick('latitude','lat');
    const iLon = pick('longitude','lon','lng','long');
    const iCnt = pick('count','sightings','total','value');

    const byKey = new Map();
    for (const r of rows){
      if ((r[iCountry]||'').trim().toLowerCase() !== 'us') continue;
      const city = (r[iCity]||'').trim();
      const state = (r[iState]||'').trim();
      const lat = smartDeg((r[iLat]||'').replace(',', '.'));
      const lon = smartDeg((r[iLon]||'').replace(',', '.'));
      const count = smartInt(r[iCnt]);
      if (!isFinite(lat)||!isFinite(lon)||!isFinite(count)) continue;
      if (lat < 18 || lat > 72 || lon > -60 || lon < -170) continue;

      const key = city.toLowerCase()+'|'+state.toLowerCase();
      const cur = byKey.get(key) || {city, state, latSum:0, lonSum:0, n:0, count:0};
      cur.latSum += lat; cur.lonSum += lon; cur.n += 1; cur.count += count;
      byKey.set(key, cur);
    }
    let values = [...byKey.values()].map(d=>({ city:d.city, state:d.state, lat:d.latSum/d.n, lon:d.lonSum/d.n, count:d.count }));
    values.sort((a,b)=>b.count-a.count);
    values = values.slice(0,300);

    const counts = values.map(d=>d.count).filter(n=>n>0).sort((a,b)=>a-b);
    const q99 = counts.length ? counts[Math.floor(0.99*(counts.length-1))] : 1;
    const domainMax = Math.max(1, q99);

    const fmt = new Intl.NumberFormat('en-US').format;
    const totalTop = values.reduce((s,d)=>s+d.count,0);
    const top5 = values.slice(0,5).map(d => `${d.city}, ${d.state} (${fmt(d.count)})`).join(', ');
    const desc = document.getElementById('citiesmap-desc');
    if (desc){
      desc.textContent = `Each bubble on the map represents a city, with its size showing how many UFO sightings were reported there. To make the data pop against a dark background, the map uses a clean white basemap for contrast. The visual highlights the top 300 cities, which together account for ${fmt(totalTop)} reports, nearly a third of all U.S. sightings. Leading the list are Seattle, WA (472), Phoenix, AZ (439), Las Vegas, NV (335), Los Angeles, CA (333), and San Diego, CA (319) all places known for wide-open skies and vibrant nightlife, where strange lights and unexplained glows might just catch your eye. The result is a snapshot of where curiosity and maybe a bit of cosmic wonder shines brightest.`;
    }

    const spec = {
      $schema:'https://vega.github.io/schema/vega-lite/v5.json',
      width:1180, height:420,
      projection:{ type:'albersUsa' },
      layer:[
        { data: topo, mark:{ type:'geoshape', fill:'#ffffff', stroke:'#94a3b8' } }, /* WHITE MAP */
        { data:{ values },
          transform:[ {calculate:`min(datum.count, ${domainMax})`, as:'count_capped'} ],
          mark:{ type:'circle', opacity:0.85, stroke:'#0b1220', strokeWidth:0.7, tooltip:true },
          encoding:{
            longitude:{ field:'lon', type:'quantitative' },
            latitude: { field:'lat', type:'quantitative' },
            size:{ field:'count_capped', type:'quantitative',
                   scale:{ type:'linear', domain:[0, domainMax], clamp:true, range:[40, 260] },
                   title:'City sightings',
                   legend:{ orient:'right', values:[0,50,100,150,200,300], format:',d',
                            labelColor:'#e5e7eb', titleColor:'#e5e7eb', labelFontSize:13, titleFontSize:13,
                            symbolStrokeColor:'#0b1220', symbolStrokeWidth:0.8 } },
            color:{ value:'#38bdf8' },
            tooltip:[ {field:'city', title:'City'}, {field:'state', title:'State'}, {field:'count', type:'quantitative', title:'Reports', format:',d'} ]
          } }
      ],
      config:{ background:null }
    };
    await vegaEmbed('#citiesmap', spec, {actions:false});
  }catch(e){ console.error('Cities map error:', e); }
}

/* ---------------- D) HOURLY (radial) ---------------- */
async function renderHourly(){
  try{
    const {text} = await fetchFirst(PATHS.hourly);
    const first = (text.split(/\r?\n/)[0]||''); const delim = first.includes('\t') ? '\t' : (first.includes(';') ? ';' : ',');
    const rows = text.trim().split(/\r?\n/).filter(Boolean).map(r=>r.split(delim));
    const head = rows.shift().map(h=>h.trim().toLowerCase());
    const iH = head.indexOf("hour");
    const iC = Math.max(head.indexOf("count"), head.indexOf("total"), head.indexOf("value"), head.indexOf("reports"));

    let values = rows.map(c=>({hour:+c[iH], count:smartInt(c[iC])})).filter(d=>Number.isFinite(d.hour)&&Number.isFinite(d.count));
    const have = new Set(values.map(d=>d.hour)); for(let h=0;h<24;h++) if(!have.has(h)) values.push({hour:h,count:0});
    values.sort((a,b)=>a.hour-b.hour);

    const spec = {
      $schema:'https://vega.github.io/schema/vega-lite/v5.json',
      width:560, height:420,
      data:{ values },
      transform:[{ calculate:'format(datum.hour,"02")', as:'hlabel' }],
      layer:[
        { mark:{ type:'arc', innerRadius:80, cornerRadius:3, stroke:'#0b1220', strokeWidth:0.6 },
          encoding:{
            theta:{ field:'hlabel', type:'nominal', sort:null, title:null },
            radius:{ field:'count', type:'quantitative', title:'Reports', scale:{ rangeMin:80, rangeMax:190 } },
            color:{ field:'count', type:'quantitative', title:'Reports', scale:{ scheme:'cividis' },
                    legend:{ orient:'right', tickCount:5, format:',d', titleColor:'#e5e7eb', labelColor:'#e5e7eb', gradientLength:160 } },
            tooltip:[ {field:'hour', title:'Hour (00–23)'}, {field:'count', type:'quantitative', title:'Reports', format:',d'} ]
          } },
        { mark:{ type:'text', radius:205, fontSize:10, fill:'#e5e7eb' },
          encoding:{ theta:{ field:'hlabel', type:'nominal', sort:null }, text:{ field:'hlabel' } } }
      ],
      view:{ stroke:null }, config:{ background:null }
    };
    await vegaEmbed('#hourly', spec, {actions:false});
  }catch(e){ console.error('Hourly error:', e); }
}

/* ---------------- E) TOP 10 CITIES ---------------- */
async function renderCities(){
  try{
    const {text} = await fetchFirst(PATHS.cities);
    const first = (text.split(/\r?\n/)[0]||''); const delim = first.includes('\t') ? '\t' : (first.includes(';') ? ';' : ',');
    const rows = text.trim().split(/\r?\n/).filter(Boolean).map(r=>r.split(delim));
    const head = rows.shift().map(h=>h.trim().toLowerCase());
    const iCity=head.indexOf("city"), iC=Math.max(head.indexOf("count"), head.indexOf("total"));

    let values = rows.map(c=>({ city:(c[iCity]||'').toLowerCase().trim(), count:smartInt(c[iC]) }))
                     .filter(r=>r.city && Number.isFinite(r.count))
                     .sort((a,b)=>b.count-a.count).slice(0, 10);

    const titleCase = s => s.replace(/\b\w/g, m=>m.toUpperCase());
    values = values.map(d => ({...d, cityLabel: titleCase(d.city)}));

    const top = values[0];
    const totalTop10 = values.reduce((s,d)=>s+d.count,0);
    const fmt = new Intl.NumberFormat('en-US').format;
    const desc = document.getElementById('cities-desc');
    if (desc){
      const list = values.slice(0,5).map(d=>`${titleCase(d.city)} (${fmt(d.count)})`).join(', ');
      desc.textContent = `The map highlights the cities that have reported the most UFO sightings across the U.S., with ${titleCase(top.city)} taking the top spot at ${fmt(top.count)} sightings. In total, the top ten cities contribute an impressive ${fmt(totalTop10)} reports, showing just how concentrated some of these “hotspots” are. Other standout locations include Phoenix (423), Portland (342), Las Vegas (339), and Los Angeles (333), all cities where bright skies, bustling nightlife, and open horizons might make mysterious lights hard to ignore. These clusters suggest that UFO fascination thrives not just in remote areas, but also in the heart of America’s most active urban centers.`;
    }

    const spec = {
      $schema:'https://vega.github.io/schema/vega-lite/v5.json',
      width: 560, height: 360,
      padding: {left: 90, right: 20, top: 10, bottom: 30},
      data:{ values },
      layer: [
        { mark:{ type:'bar', cornerRadiusEnd: 4 },
          encoding:{
            y:{ field:'cityLabel', type:'nominal', sort:'-x', title:null, axis:{labelColor:'#e5e7eb'} },
            x:{ field:'count', type:'quantitative', title:'Reports',
                axis:{labelColor:'#e5e7eb', titleColor:'#e5e7eb', gridColor:'#1f2937'} },
            color:{ condition:{ test:`datum.city === '${top.city}'`, value:'#38bdf8' }, value:'#64748b' },
            tooltip:[ {field:'cityLabel', title:'City'}, {field:'count', type:'quantitative', title:'Reports', format:',d'} ]
          } },
        { mark:{ type:'text', align:'left', dx:6, fontSize:11, fill:'#e5e7eb' },
          encoding:{ y:{ field:'cityLabel', type:'nominal', sort:'-x' }, x:{ field:'count', type:'quantitative' },
                     text:{ field:'count', type:'quantitative', format:',d' } } }
      ],
      config:{ background:null, view:{stroke:null} }
    };
    await vegaEmbed('#cities', spec, {actions:false});
  }catch(e){ console.error('Cities (top 10) error:', e); }
}

/* ---------------- F) SHAPES — single 100% stacked bar (ALL shapes) ---------------- */
async function renderShapes(){
  try{
    const {text} = await fetchFirst(PATHS.shapes);
    const first = (text.split(/\r?\n/)[0]||''); const delim = first.includes('\t') ? '\t' : (first.includes(';') ? ';' : ',');
    const rows = text.trim().split(/\r?\n/).filter(Boolean).map(r=>r.split(delim));
    const head = rows.shift().map(h=>h.trim().toLowerCase());
    const iS = head.indexOf("shape");
    const iC = Math.max(head.indexOf("count"), head.indexOf("total"), head.indexOf("value"));

    let values = rows.map(c => ({ shape:(c[iS]||'').toString().trim(), count: smartInt(c[iC]) }))
                     .filter(d=>d.shape && Number.isFinite(d.count));
    const total = values.reduce((s,d)=>s+d.count,0);
    values = values.map(d=>({ ...d, pct: total ? d.count/total : 0 }));

    // Sort by size desc so segments appear left->right largest first
    values.sort((a,b)=>b.count-a.count);

    const spec = {
      $schema:'https://vega.github.io/schema/vega-lite/v5.json',
      width:560, height:160,
      data:{ values },
      transform:[ { calculate: '"All shapes"', as:'cat' } ],
      mark:{ type:'bar' },
      encoding:{
        y:{ field:'cat', type:'nominal', title:null, axis:{labels:false, ticks:false, domain:false} },
        x:{ field:'pct', type:'quantitative', stack:'normalize', title:null,
            axis:{ format:'%', labelColor:'#e5e7eb', titleColor:'#e5e7eb' } },
        color:{ field:'shape', type:'nominal', title:'Shape',
                legend:{ columns:2, labelColor:'#e5e7eb', titleColor:'#e5e7eb' } },
        tooltip:[
          { field:'shape', title:'Shape' },
          { field:'count', type:'quantitative', title:'Reports', format:',d' },
          { field:'pct', type:'quantitative', title:'Share', format:'.1%' }
        ]
      },
      config:{ background:null, view:{stroke:null} }
    };
    await vegaEmbed('#shapes', spec, {actions:false});

    const fmt = new Intl.NumberFormat('en-US').format;
    const p = document.getElementById('shapes-desc');
    if (p) p.textContent = `This chart compresses all UFO shape reports into a single 100% stacked bar, giving a clear view of the overall mix at a glance. Larger segments represent the most commonly reported shapes like lights, triangles, circles, and fireballs, while smaller slivers show the rarer, more unusual forms such as cigars, chevrons, and disks. Hover over each segment to see its exact count and share of the ${fmt(total)} shape-labelled reports. Categories like “unknown/other” collect ambiguous descriptions, so they’re best seen as a catch-all rather than a specific shape. The pattern is clear: most sightings cluster around a few familiar shapes, with many unique forms making up only a small fraction of the total.`;
  }catch(e){ console.error('Shapes error:', e); }
}

/* ---------------- G) YEARLY — focus + context (brush) ---------------- */
async function renderYearly(){
  // csv helper
  const parseCSV = (text) => {
    const first = (text.split(/\r?\n/)[0]||'');
    const delim = first.includes('\t') ? '\t' : (first.includes(';') ? ';' : ',');
    const rows = text.trim().split(/\r?\n/).filter(Boolean).map(r=>r.split(delim));
    const head = (rows.shift()||[]).map(h=>h.trim().toLowerCase());
    return { head, rows };
  };

  // Try tidy yearly file
  async function loadYearCSV(){
    try{
      const {text} = await fetchFirst(PATHS.yearly);
      const {head, rows} = parseCSV(text);
      const iY = head.indexOf('year');
      const iC = Math.max(head.indexOf('count'), head.indexOf('total'), head.indexOf('value'), head.indexOf('sightings'));
      if (iY<0 || iC<0) return [];
      return rows.map(r=>({year:+r[iY], count:smartInt(r[iC])}))
                 .filter(d=>Number.isFinite(d.year)&&Number.isFinite(d.count))
                 .sort((a,b)=>a.year-b.year);
    }catch{ return []; }
  }

  // Fallback: build from scrubbed.csv (US only)
  async function buildFromRaw(){
    try{
      const {text} = await fetchFirst(PATHS.raw);
      const {head, rows} = parseCSV(text);
      const iCountry = head.indexOf('country');
      const iDT = [head.indexOf('datetime'), head.indexOf('date_time'), head.indexOf('date'),
                   head.indexOf('occurred'), head.indexOf('sighted_at')].find(i=>i>=0);
      if (iDT === undefined || iDT < 0) return [];  // <— guard
      const byYear = new Map();
      for (const r of rows){
        if (iCountry>=0 && (r[iCountry]||'').trim().toLowerCase()!=='us') continue;
        const m = String(r[iDT]||'').match(/(\d{4})/);
        if (!m) continue;
        const y = +m[1];
        if (!Number.isFinite(y)) continue;
        byYear.set(y, (byYear.get(y)||0)+1);
      }
      return [...byYear.entries()].map(([year,count])=>({year,count})).sort((a,b)=>a.year-b.year);
    }catch{ return []; }
  }

  // Get data
  let values = await loadYearCSV();
  if (!values.length) values = await buildFromRaw();

  const mount = document.getElementById('yearly');
  if (!values.length){
    mount.innerHTML = '<p style="opacity:.75">No yearly data available.</p>';
    return;
  }

  // Stats + caption
  const fmt = new Intl.NumberFormat('en-US').format;
  const span = `${values[0].year}–${values[values.length-1].year}`;
  const total = values.reduce((s,d)=>s+d.count,0);
  const peak = values.reduce((a,b)=> (b.count>a.count?b:a), values[0]);

  // 5-yr average
  const ma5 = [];
  for (let i=0, run=0; i<values.length; i++){
    run += values[i].count;
    if (i>=5) run -= values[i-5].count;
    ma5.push({year: values[i].year, avg5: (i>=4) ? run/5 : null});
  }

  const p = document.getElementById('yearly-desc');
  if (p){
    p.textContent = Each point on the chart shows the total number of UFO reports for a given year. The trend stays relatively flat through much of the mid-20th century, then rises sharply from the late 1990s into the 2000s before gradually easing off. The dashed line represents a five-year moving average, which smooths out short-term fluctuations to make the long-term pattern easier to see. You can use the brush in the lower panel to zoom into any period, which filters the main chart to that span, and hovering over the line shows the exact year and report count. This chart reveals more than just sightings; it reflects social and technological factors such as media coverage, reporting channels, and the spread of the internet that have shaped how and when people report UFOs over time.`;
  }

  // Focus+context spec
  const PEAK_YEAR = peak.year;
  const focusContext = {
    $schema:'https://vega.github.io/schema/vega-lite/v5.json',
    vconcat: [
      {
        width:560, height:320,
        data:{ values },
        params: [
          { name: "hover", select: {type:"point", fields:["year"], nearest:true, on:"mouseover", clear:"mouseout"} },
          { name: "brush", select: {type:"interval", encodings:["x"]} }
        ],
        layer: [
          { mark:{type:'area', opacity:0.10, color:'#38bdf8'},
            encoding:{
              x:{field:'year', type:'quantitative', title:'Year',
                 axis:{labelColor:'#e5e7eb', titleColor:'#e5e7eb'}, scale:{domain:{param:"brush"}}},
              y:{field:'count', type:'quantitative', title:'Sightings',
                 axis:{labelColor:'#e5e7eb', titleColor:'#e5e7eb'}}
            } },
          { mark:{type:'line', color:'#38bdf8', strokeWidth:1.5},
            encoding:{ x:{field:'year', type:'quantitative', scale:{domain:{param:"brush"}}},
                       y:{field:'count', type:'quantitative'} } },
          { data:{values: ma5.filter(d=>d.avg5!=null)},
            mark:{type:'line', color:'#9dd6ff', strokeDash:[4,3], strokeWidth:2},
            encoding:{ x:{field:'year', type:'quantitative', scale:{domain:{param:"brush"}}},
                       y:{field:'avg5', type:'quantitative', title:'5-yr average'} } },
          { mark:{type:'point', filled:true, size:40, color:'#38bdf8'},
            encoding:{ x:{field:'year', type:'quantitative', scale:{domain:{param:"brush"}}},
                       y:{field:'count', type:'quantitative'},
                       opacity:{ condition:{param:'hover', empty:false, value:1}, value:0 } } },
          { mark:{type:'point', opacity:0},
            encoding:{ x:{field:'year', type:'quantitative', scale:{domain:{param:"brush"}}},
                       y:{field:'count', type:'quantitative'},
                       tooltip:[ {field:'year', title:'Year'},
                                 {field:'count', type:'quantitative', title:'Reports', format:',d'} ] } },
          { data:{ values:[ { x: PEAK_YEAR } ] },
            mark:{ type:'rule', stroke:'#e5e7eb', strokeDash:[4,3] },
            encoding:{ x:{ field:'x', type:'quantitative', scale:{domain:{param:'brush'}} } } }
        ],
        config:{ background:null, axis:{gridColor:'#1f2937'} }
      },
      {
        width:560, height:90,
        data:{ values },
        mark:{ type:'area', opacity:0.15, color:'#38bdf8' },
        params:[ { name:"brush", select:{type:"interval", encodings:["x"]} } ],
        encoding:{
          x:{ field:'year', type:'quantitative', title:null,
              axis:{labels:false,ticks:false,domain:false} },
          y:{ field:'count', type:'quantitative', title:null,
              axis:{labels:false,ticks:false,domain:false} }
        },
        config:{ background:null, view:{stroke:null} }
      }
    ],
    config:{ background:null }
  };

  // Simple single-line fallback
  const simple = {
    $schema:'https://vega.github.io/schema/vega-lite/v5.json',
    width:560, height:320,
    data:{ values },
    layer:[
      { mark:{ type:'area', opacity:0.10, color:'#38bdf8'},
        encoding:{ x:{field:'year', type:'quantitative', title:'Year',
                       axis:{labelColor:'#e5e7eb', titleColor:'#e5e7eb'}},
                   y:{field:'count', type:'quantitative', title:'Sightings',
                       axis:{labelColor:'#e5e7eb', titleColor:'#e5e7eb'}} } },
      { mark:{type:'line', color:'#38bdf8', strokeWidth:1.5},
        encoding:{ x:{field:'year', type:'quantitative'}, y:{field:'count', type:'quantitative'} } },
      { data:{values: ma5.filter(d=>d.avg5!=null)},
        mark:{type:'line', color:'#9dd6ff', strokeDash:[4,3], strokeWidth:2},
        encoding:{ x:{field:'year', type:'quantitative'}, y:{field:'avg5', type:'quantitative'} } }
    ],
    config:{ background:null, axis:{gridColor:'#1f2937'} }
  };

  try{
    await vegaEmbed('#yearly', focusContext, {actions:false});
  }catch(err){
    console.warn('Focus+context render failed; using fallback chart:', err);
    await vegaEmbed('#yearly', simple, {actions:false});
  }
}

/* ---------------- RUN ALL ---------------- */
Promise.all([
  renderKPIs(),
  renderStateChoropleth(),
  renderMapFromCities(),
  renderHourly(),
  renderCities(),
  renderShapes(),
  renderYearly()
]);
</script>
</body>
</html>
