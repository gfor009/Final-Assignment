<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>UFO Sightings Explorer — USA Focus</title>

<!-- Vega -->
<script src="https://unpkg.com/vega@5"></script>
<script src="https://unpkg.com/vega-lite@5"></script>
<script src="https://unpkg.com/vega-embed@6"></script>

<!-- Typography -->
<link href="https://fonts.googleapis.com/css2?family=Oxanium:wght@600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#0b1120;
    --panel:#0f172a;
    --grid:#1f2937;
    --ink:#e5e7eb;
    --muted:#94a3b8;
    --accent:#38bdf8;
    --accent-soft:#9dd6ff;
    --gap-1:12px; --gap-2:16px; --gap-3:24px; --gap-4:32px; --gap-5:48px;
    --radius:16px;
    --container:1240px;
  }
  html, body { height: 100% }
  body{
    margin:0; background:var(--bg); color:var(--ink);
    font: 14.5px/1.6 Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
  }
  .container{ max-width:var(--container); margin:auto; padding:var(--gap-4) var(--gap-3) }

  header.hero{ margin:0 0 var(--gap-4) }
  header.hero h1{ margin:0 0 6px; font:700 28px/1.15 Oxanium, sans-serif; letter-spacing:.2px; }
  header.hero p{ margin:0; color:var(--muted) }

  .lede{opacity:.9;margin:.25rem 0 1rem;max-width:78ch}
  .kpis{ display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin:18px 0 8px }
  .kpi{
    background:var(--panel);border:1px solid var(--grid);border-radius:14px;
    padding:14px 16px;display:flex;flex-direction:column;gap:4px;
  }
  .kpi-number{font-size:28px;line-height:1;font-weight:800;letter-spacing:.3px;color:var(--ink)}
  .kpi-label{font-size:12px;opacity:.8}
  @media (max-width:900px){.kpis{grid-template-columns:1fr 1fr}}

  .grid{ display:grid; grid-template-columns:1fr 1fr; gap:var(--gap-3) }
  .wide{ grid-column:1 / -1 }

  .card{ background:var(--panel); border:1px solid var(--grid); border-radius:var(--radius); padding:var(--gap-3); }
  .card h2{ margin:0 0 var(--gap-2); font:600 20px/1.25 Oxanium, sans-serif }

  .viz{ min-height:340px }
  .caption{ margin:.4rem 0 0; color:var(--muted) }

  footer.meta{ margin:var(--gap-5) 0 0; color:var(--muted); border-top:1px solid var(--grid); padding-top:var(--gap-3); font-size:13px; }

  /* improve VL readability on dark */
  .vega-embed .vega-legend text,
  .vega-embed .leg-title { fill:var(--ink) !important }
  .vega-embed .role-axis-label, .vega-embed .role-axis-title { fill:var(--ink) !important }
  .vega-embed .role-axis-grid, .vega-embed .mark-rule { stroke:var(--grid) !important }

  @media (max-width: 980px){ .grid{ grid-template-columns:1fr } }
</style>
</head>

<body>
<div class="container">
  <header class="hero">
    <h1>UFO Sightings in America — Where, When, and What We See</h1>
    <p id="intro" class="lede">
      An annotated tour of U.S. UFO reports: which states and cities report the most, how sightings
      rise and fall through time, what shapes people claim to see, and when in the day they look up.
      The aim is to show patterns you can verify from the data — not to prove or debunk anything —
      which is exactly why this dataset is fun: it mixes geography, culture, and time in one story.
      This visualisation turns thousands of NUFORC reports into a guided tour of the American UFO imagination. 
  We start wide—state and city maps reveal where reports cluster—then move through time to watch waves of sightings rise and fade, and finally zoom in on the shapes and hours people most often describe.
    </p>
  </header>

  <!-- KPI STRIP -->
  <div class="kpis">
    <div class="kpi"><div class="kpi-number" id="kpi-total">—</div><div class="kpi-label">Total U.S. reports</div></div>
    <div class="kpi"><div class="kpi-number" id="kpi-states">—</div><div class="kpi-label">States covered</div></div>
    <div class="kpi"><div class="kpi-number" id="kpi-peak">—</div><div class="kpi-label">Peak year (reports)</div></div>
    <div class="kpi"><div class="kpi-number" id="kpi-topcity">—</div><div class="kpi-label">Top city (reports)</div></div>
  </div>

  <section class="grid">
    <article class="card wide">
      <h2>Where are reports concentrated? (by state)</h2>
      <div id="chor" class="viz" aria-label="Choropleth of total reports by U.S. state"></div>
      <p id="chor-desc" class="caption"></p>
    </article>

    <article class="card wide">
      <h2>City hotspots (top 300 bubbles)</h2>
      <div id="citiesmap" class="viz" aria-label="Bubble map of top-reporting cities"></div>
      <p id="citiesmap-desc" class="caption"></p>
    </article>

    <article class="card wide">
      <h2>Monthly UFO reports in the U.S.</h2>
      <div id="monthly" class="viz" aria-label="Monthly time series with 12-month average"></div>
      <p id="monthly-desc" class="caption"></p>
    </article>

    <article class="card">
      <h2>When in the day? (radial)</h2>
      <div id="hourly" class="viz" aria-label="Radial bar chart of reports by hour"></div>
      <p class="caption">Evening hours dominate; labels on the rim aid orientation.</p>
    </article>

    <article class="card">
      <h2>Top 10 cities for UFO reports (No.1 highlighted)</h2>
      <div id="cities" class="viz" aria-label="Bar ranking of top 10 cities"></div>
      <p id="cities-desc" class="caption"></p>
    </article>

    <article class="card">
      <h2>What do people report? (shapes, ranked)</h2>
      <div id="shapes" class="viz" aria-label="Lollipop chart of reported shapes"></div>
      <p id="shapes-desc" class="caption"></p>
    </article>

    <article class="card wide">
      <h2>UFO reports by year (interactive focus + context)</h2>
      <div id="yearly" class="viz" aria-label="Yearly series with 5-year average and brush"></div>
      <p id="yearly-desc" class="caption"></p>
    </article>
  </section>

  <footer class="meta">
    <strong>Data:</strong> NUFORC “scrubbed.csv” + derived aggregates. <strong>Scope:</strong> U.S. only.  
    <strong>Author:</strong> Your Name • <strong>Date:</strong> <span id="today"></span> •
    <strong>Tools:</strong> Vega-Lite 5, GitHub Pages.  
    <strong>Notes:</strong> Outliers capped where noted; coordinates cleaned; legends/axes harmonised for consistent figure–ground.
  </footer>
</div>
<script>document.getElementById('today').textContent = new Date().toLocaleDateString();</script>

<script>
/* ---------- PATHS & HELPERS ---------- */
const PATHS = {
  raw:     ["data/scrubbed.csv","scrubbed.csv","https://gfor009.github.io/FIT3179/scrubbed.csv"],
  citiesLatLon: ["data/ufo_cities_latlon.csv","ufo_cities_latlon.csv"],
  cities:  ["data/ufo_cities.csv","ufo_cities.csv"],
  monthly: ["data/ufo_monthly.csv","ufo_monthly.csv"],
  shapes:  ["data/ufo_shape.csv","ufo_shape.csv"],
  hourly:  ["data/ufo_hourly.csv","ufo_hourly.csv"],
  yearly:  ["data/ufo_year.csv","ufo_year.csv"]
};

async function fetchFirst(paths){
  let lastErr;
  for (const p of paths){
    try{
      const r = await fetch(p + "?v=" + Date.now());
      if(!r.ok) throw new Error(r.status + " " + r.statusText);
      return {url:p, text: await r.text()};
    }catch(e){ lastErr = e; }
  }
  throw lastErr || new Error("All paths failed");
}
function smartInt(s){
  const t = String(s ?? '').trim();
  if (/^\d{1,3}([.,\s]\d{3})+$/.test(t)) return Number(t.replace(/[.,\s]/g,''));
  return Number(t.replace(/[,\s]/g,''));
}
function smartDeg(s){
  const t = String(s ?? "").trim();
  const direct = Number(t.replace(',', '.'));
  if (isFinite(direct)) return direct;
  const neg = t.startsWith('-') ? -1 : 1;
  const digits = t.replace(/[^0-9]/g, '');
  if (!digits) return NaN;
  const scale = Math.pow(10, Math.max(7, digits.length - 2));
  return neg * (Number(digits) / scale);
}
function ymKey(s){
  const str = String(s||'').trim();
  let m = str.match(/^\s*(\d{4})[-\/. ]?(\d{1,2})\s*$/);
  if (m) return `${m[1]}-${m[2].padStart(2,'0')}`;
  m = str.match(/(\d{4}).*?(\d{1,2})/);
  if (m) return `${m[1]}-${m[2].padStart(2,'0')}`;
  const names={jan:1,feb:2,mar:3,apr:4,may:5,jun:6,jul:7,aug:8,sep:9,oct:10,nov:11,dec:12};
  const m2=str.match(/\b(jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec)[a-z]*\b.*?(\d{4})/i);
  if(m2) return `${m2[2]}-${String(names[m2[1].toLowerCase()]).padStart(2,'0')}`;
  return null;
}
const BLUE = '#38bdf8';

/* ---------- KPIs ---------- */
async function renderKPIs(){
  const parseCSV = (text) => {
    const first = (text.split(/\r?\n/)[0]||'');
    const delim = first.includes('\t') ? '\t' : (first.includes(';') ? ';' : ',');
    const rows = text.trim().split(/\r?\n/).filter(Boolean).map(r=>r.split(delim));
    const head = (rows.shift()||[]).map(h=>h.trim().toLowerCase());
    return {head, rows};
  };

  let totalUS = 0;
  let peakYear = {year:'—', count:0};
  const states = new Set();

  try{
    const {text} = await fetchFirst(PATHS.raw);
    const {head, rows} = parseCSV(text);

    const iCountry = head.indexOf('country');
    const iState   = Math.max(head.indexOf('state'), head.indexOf('state/province'));
    const iDT      = [head.indexOf('datetime'), head.indexOf('date_time'), head.indexOf('date'),
                      head.indexOf('occurred'), head.indexOf('sighted_at')].find(i=>i>=0);

    const byYear = new Map();

    for (const r of rows){
      if (iCountry>=0 && (r[iCountry]||'').trim().toLowerCase()!=='us') continue;
      totalUS++;
      if (iState>=0) states.add((r[iState]||'').trim().toUpperCase());
      if (iDT>=0){
        const m = String(r[iDT]||'').match(/(\d{4})/);
        if (m){ const y=+m[1]; byYear.set(y, (byYear.get(y)||0)+1); }
      }
    }

    if (byYear.size){
      const arr = [...byYear.entries()].map(([year,count])=>({year,count})).sort((a,b)=>b.count-a.count);
      peakYear = arr[0];
    }
  }catch(e){ console.warn('KPI (raw) failed:', e); }

  let topCity = {label:'—', count:0};
  try{
    const {text} = await fetchFirst(PATHS.citiesLatLon);
    const {head, rows} = parseCSV(text);
    const iCity = head.indexOf('city');
    const iState = Math.max(head.indexOf('state'), head.indexOf('region'));
    const iCountry = head.indexOf('country');
    const iCnt = Math.max(head.indexOf('count'), head.indexOf('sightings'), head.indexOf('total'), head.indexOf('value'));

    const agg = new Map();
    for (const r of rows){
      if (iCountry>=0 && (r[iCountry]||'').trim().toLowerCase()!=='us') continue;
      const city  = (r[iCity]||'').trim();
      const state = (r[iState]||'').trim();
      const cnt   = smartInt(r[iCnt]);
      if (!city || !Number.isFinite(cnt)) continue;
      const key = `${city}__${state}`;
      agg.set(key, (agg.get(key)||0) + cnt);
    }
    if (agg.size){
      const [key,count] = [...agg.entries()].sort((a,b)=>b[1]-a[1])[0];
      const [c,s] = key.split('__');
      topCity = {label:`${c}, ${s}`, count};
    }
  }catch(e){ console.warn('KPI (cities) failed:', e); }

  const fmt = new Intl.NumberFormat('en-US').format;
  const el = (id, v) => { const n=document.getElementById(id); if(n) n.textContent=v; };

  el('kpi-total',   fmt(totalUS));
  el('kpi-states',  states.size ? `${states.size}/51` : '—');
  el('kpi-peak',    (peakYear.year!=='—') ? `${peakYear.year} (${fmt(peakYear.count)})` : '—');
  el('kpi-topcity', topCity.count ? `${topCity.label} (${fmt(topCity.count)})` : '—');
}

/* ---------- A) STATE CHOROPLETH ---------- */
async function renderStateChoropleth(){
  try{
    const topo = { url:'https://vega.github.io/vega-datasets/data/us-10m.json',
                   format:{ type:'topojson', feature:'states' } };
    const FIPS = [
  ["AL",1],["AK",2],["AZ",4],["AR",5],["CA",6],["CO",8],["CT",9],["DE",10],["DC",11],
  ["FL",12],["GA",13],["HI",15],["ID",16],["IL",17],["IN",18],["IA",19],["KS",20],
  ["KY",21],["LA",22],["ME",23],["MD",24],["MA",25],["MI",26],["MN",27],["MS",28],
  ["MO",29],["MT",30],["NE",31],["NV",32],["NH",33],["NJ",34],["NM",35],["NY",36],
  ["NC",37],["ND",38],["OH",39],["OK",40],["OR",41],["PA",42],["RI",44],["SC",45],
  ["SD",46],["TN",47],["TX",48],["UT",49],["VT",50],["VA",51],["WA",53],["WV",54],
  ["WI",55],["WY",56]
];
const VALID_STATES = new Set(FIPS.map(([abbr]) => abbr));

// … after you fill `states` from the data:
const covered = [...states].filter(s => VALID_STATES.has(s)).length;

// Show “States + DC” to be explicit:
document.getElementById('kpi-states').textContent = `${covered}/51`;

    const {text} = await fetchFirst(PATHS.raw);
    const first = (text.split(/\r?\n/)[0]||'');
    const delim = first.includes(';')?';':',';
    const rows = text.trim().split(/\r?\n/).filter(Boolean).map(r=>r.split(delim));
    const head = rows.shift().map(h=>h.trim().toLowerCase());
    const idx = n => head.indexOf(n);
    const iCountry = idx('country');
    const iState = Math.max(idx('state'), idx('state/province'));
    if (iCountry<0 || iState<0) throw new Error('Missing country/state in scrubbed.csv');

    const byState = new Map();
    for (const r of rows){
      if ((r[iCountry]||'').trim().toLowerCase() !== 'us') continue;
      const abbr = (r[iState]||'').trim().toUpperCase();
      if (!fipsMap.has(abbr)) continue;
      byState.set(abbr, (byState.get(abbr)||0) + 1);
    }
    const counts = [];
    for (const [abbr,n] of byState) counts.push({id:fipsMap.get(abbr), abbr, count:n});

    const fmt = new Intl.NumberFormat('en-US').format;
    const sorted = counts.slice().sort((a,b)=>b.count-a.count);
    const top = sorted.slice(0,3).map(d=>`${d.abbr} (${fmt(d.count)})`).join(', ');
    const bottom = sorted.slice(-3).map(d=>`${d.abbr} (${fmt(d.count)})`).join(', ');
    const total = counts.reduce((s,d)=>s+d.count,0);
    const descEl = document.getElementById('chor-desc');
    if (descEl){
      descEl.textContent =
        `Each state is coloured by its total number of UFO reports. The dataset totals ${fmt(total)} U.S. sightings. ` +
        `Highest: ${top}. Lowest: ${bottom}. Larger, more populous states tend to report more sightings.`;
    }

    const spec = {
      $schema:'https://vega.github.io/schema/vega-lite/v5.json',
      width:1180, height:420,
      data: topo,
      transform:[{
        lookup:'id',
        from:{ data:{ values:counts }, key:'id', fields:['count','abbr'] }
      }],
      mark:{ type:'geoshape', stroke:'#98a0ab', strokeWidth:0.7 },
      encoding:{
        color:{
          field:'count', type:'quantitative', title:'Total sightings',
          scale:{ scheme:'blues' },
          legend:{
            orient:'right', gradientLength:240, tickCount:6, format:',d',
            titleColor:'#e5e7eb', labelColor:'#e5e7eb', titleFontSize:12, labelFontSize:11
          }
        },
        tooltip:[
          { field:'abbr', title:'State' },
          { field:'count', type:'quantitative', title:'Sightings', format:',d' }
        ]
      },
      projection:{ type:'albersUsa' },
      config:{ background:null }
    };
    await vegaEmbed('#chor', spec, {actions:false});
  }catch(e){ console.error('Choropleth error:', e); }
}

/* ---------- B) CITY BUBBLE MAP ---------- */
async function renderMapFromCities(){
  try{
    const topo = { url:'https://vega.github.io/vega-datasets/data/us-10m.json',
                   format:{ type:'topojson', feature:'states' } };

    const {text} = await fetchFirst(PATHS.citiesLatLon);
    const first = (text.split(/\r?\n/)[0]||''); 
    const delim = first.includes(';') ? ';' : ',';
    const rows = text.trim().split(/\r?\n/).filter(Boolean).map(r=>r.split(delim));
    const head = rows.shift().map(h=>h.trim().toLowerCase());
    const pick = (...names)=> names.map(n=>head.indexOf(n)).find(i=>i>=0);

    const iCity = pick('city');
    const iState = pick('state','region');          /* FIXED */
    const iCountry = pick('country');
    const iLat = pick('latitude','lat');
    const iLon = pick('longitude','lon','lng','long');
    const iCnt = pick('count','sightings','total','value');
    if ([iCity,iState,iCountry,iLat,iLon,iCnt].some(i=>i===undefined)) throw new Error('Missing columns');

    const byKey = new Map();
    for (const r of rows){
      if ((r[iCountry]||'').trim().toLowerCase() !== 'us') continue;
      const city = (r[iCity]||'').trim();
      const state = (r[iState]||'').trim();
      const lat = smartDeg((r[iLat]||'').replace(',', '.'));
      const lon = smartDeg((r[iLon]||'').replace(',', '.'));
      const count = smartInt(r[iCnt]);
      if (!isFinite(lat)||!isFinite(lon)||!isFinite(count)) continue;
      if (lat < 18 || lat > 72 || lon > -60 || lon < -170) continue;

      const key = city.toLowerCase()+'|'+state.toLowerCase();
      const cur = byKey.get(key) || {city, state, latSum:0, lonSum:0, n:0, count:0};
      cur.latSum += lat; cur.lonSum += lon; cur.n += 1; cur.count += count;
      byKey.set(key, cur);
    }

    let values = [...byKey.values()].map(d=>({
      city:d.city, state:d.state, lat:d.latSum/d.n, lon:d.lonSum/d.n, count:d.count
    }));
    values.sort((a,b)=>b.count-a.count);
    values = values.slice(0, 300);

    const fmt = new Intl.NumberFormat('en-US').format;
    const top5 = values.slice(0,5).map(d => `${d.city}, ${d.state} (${fmt(d.count)})`).join(', ');
    const totalTop = values.reduce((s,d)=>s+d.count,0);
    const desc = document.getElementById('citiesmap-desc');
    if (desc) {
      desc.textContent =
        `Each bubble marks a city; bubble size encodes total reports. The map highlights dense corridors ` +
        `along the Northeast (D.C.–Boston), Florida, Southern California, and parts of the Great Lakes and Texas, ` +
        `with sparser coverage across the Mountain West and northern Plains. This view shows the top 300 cities ` +
        `(${fmt(totalTop)} reports). Leaders include: ${top5}.`;
    }

    const counts = values.map(d=>d.count).filter(n=>n>0).sort((a,b)=>a-b);
    const q99 = counts.length ? counts[Math.floor(0.99*(counts.length-1))] : 1;
    const domainMax = Math.max(1, q99);

    const spec = {
      $schema:'https://vega.github.io/schema/vega-lite/v5.json',
      width:1180, height:420,
      projection:{ type:'albersUsa' },
      layer:[
        { data: topo, mark:{ type:'geoshape', fill:'#091120', stroke:'#98a0ab' } },
        { data:{ values },
          transform:[ {calculate:`min(datum.count, ${domainMax})`, as:'count_capped'} ],
          mark:{ type:'circle', opacity:0.85, stroke:'#0b1220', strokeWidth:0.5, tooltip:true },
          encoding:{
            longitude:{ field:'lon', type:'quantitative' },
            latitude: { field:'lat', type:'quantitative' },
            size:{
              field:'count', type:'quantitative',
              scale:{ type:'linear', domain:[0, domainMax], clamp:true, range:[40, 260] },
              title:'City sightings',
              legend:{
                orient:'right',
                values:[0,50,100,150,200,300],
                format:',d',
                labelColor:'#e5e7eb',
                titleColor:'#e5e7eb',
                labelFontSize:14,
                titleFontSize:14,
                symbolType:'circle',
                symbolStrokeColor:'#0b1220',
                symbolStrokeWidth:0.8
              }
            },
            color:{ value: BLUE },
            tooltip:[
              {field:'city', title:'City'},
              {field:'state', title:'State'},
              {field:'count', type:'quantitative', title:'Reports', format:',d'}
            ]
          }
        }
      ],
      config:{ background:null }
    };
    await vegaEmbed('#citiesmap', spec, {actions:false});
  }catch(e){ console.error('Cities map error:', e); }
}

/* ---------- C) MONTHLY ---------- */
async function renderMonthly(){ /* unchanged from your version */ /* ... */ }

/* ---------- D) HOURLY ---------- */
async function renderHourly(){ /* unchanged from your version */ /* ... */ }

/* ---------- E) TOP 10 CITIES ---------- */
async function renderCities(){ /* unchanged from your version */ /* ... */ }

/* ---------- F) SHAPES ---------- */
async function renderShapes(){ /* unchanged from your version */ /* ... */ }

/* ---------- G) YEARLY ---------- */
async function renderYearly(){ /* unchanged from your version */ /* ... */ }

/* ---------- RUN ALL ---------- */
Promise.all([
  renderKPIs(),
  renderStateChoropleth(),
  renderMapFromCities(),
  renderMonthly(),
  renderHourly(),
  renderCities(),
  renderShapes(),
  renderYearly()
]);
</script>
</body>
</html>
