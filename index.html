<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>UFO Sightings Explorer — USA Focus</title>
<script src="https://unpkg.com/vega@5"></script>
<script src="https://unpkg.com/vega-lite@5"></script>
<script src="https://unpkg.com/vega-embed@6"></script>
<style>
  body{margin:0;background:#0f172a;color:#e5e7eb;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .container{max-width:1220px;margin:auto;padding:24px}
  h1{margin:0 0 8px}
  .card{background:#0b1220;border:1px solid #1f2937;border-radius:14px;padding:12px;margin-bottom:16px}
  .card h2{margin:0 0 8px;display:flex;align-items:center;gap:8px}
  .badge{font-size:12px;color:#a3e635;background:#052e16;border:1px solid #14532d;border-radius:999px;padding:2px 8px}
  .badge.err{color:#fecaca;background:#3f1d1d;border:1px solid #7f1d1d}
  .viz{min-height:420px}
</style>
</head>
<body>
<div class="container">
  <h1>UFO Sightings Explorer — USA Focus</h1>
  <p>This page shows a US city bubble map (from <code>ufo_cities_latlon.csv</code>) and a binned heatmap of ALL reports (from <code>scrubbed.csv</code>).</p>

  <div class="card">
    <h2>US city hotspots (map) <span id="b-map" class="badge">checking…</span></h2>
    <div id="map" class="viz"></div>
  </div>

  <div class="card">
    <h2>All sightings (binned heatmap) <span id="b-heat" class="badge">checking…</span></h2>
    <div id="heat" class="viz"></div>
  </div>
</div>

<script>
// ---------- small helpers ----------
function setBadge(id, msg, ok=true){
  const el = document.getElementById(id);
  if (!el) return;
  el.textContent = msg;
  el.className = "badge" + (ok ? "" : " err");
}
// convert weird dotted coords like "401.947.222" -> 40.1947222
function smartDeg(s){
  const t = String(s ?? "").trim();
  const direct = Number(t.replace(',', '.'));
  if (isFinite(direct)) return direct;
  const neg = t.startsWith('-') ? -1 : 1;
  const digits = t.replace(/[^0-9]/g, '');
  if (!digits) return NaN;
  const scale = Math.pow(10, Math.max(7, digits.length - 2));
  return neg * (Number(digits) / scale);
}
// robust integer for "2,345" / "2.345" / "2 345"
function smartInt(s){
  const t = String(s ?? '').trim();
  if (/^\d{1,3}([.,\s]\d{3})+$/.test(t)) return Number(t.replace(/[.,\s]/g,''));
  return Number(t.replace(/[,\s]/g,''));
}

// ---------- 1) City bubble MAP (ufo_cities_latlon.csv) ----------
async function renderMap(){
  try{
    // try /data then root
    const tryPaths = ["data/ufo_cities_latlon.csv","ufo_cities_latlon.csv"];
    let text=null, src=null;
    for(const p of tryPaths){
      const r = await fetch(p + "?v=" + Date.now());
      if (r.ok){ text = await r.text(); src = p; break; }
    }
    if(!text) throw new Error("ufo_cities_latlon.csv not found");

    // accept ; or , by normalising to ,
    const lines = text.replace(/;/g, ",").trim().split(/\r?\n/).filter(Boolean);
    const headers = lines.shift().split(",").map(h=>h.trim().toLowerCase());
    const find = n => headers.indexOf(n);
    const idx = {
      city: find("city"),
      state: Math.max(find("state"), find("region")),
      lat: Math.max(find("latitude"), find("lat")),
      lon: Math.max(find("longitude"), find("lon"), find("lng"), find("long")),
      cnt: Math.max(find("count"), find("sightings"), find("value"), find("total"))
    };

    const values = lines.map(l=>{
      const c = l.split(",");
      return {
        city: (c[idx.city] ?? "").trim(),
        state:(c[idx.state] ?? "").trim(),
        lat:  smartDeg(c[idx.lat]),
        lon:  smartDeg(c[idx.lon]),
        count: smartInt(c[idx.cnt])
      };
    }).filter(d => isFinite(d.lat) && isFinite(d.lon) && isFinite(d.count)
                   && d.lat>=-90 && d.lat<=90 && d.lon>=-180 && d.lon<=180);

    setBadge("b-map", `loaded ${values.length} rows from ${src}`);

    const spec = {
      $schema:'https://vega.github.io/schema/vega-lite/v5.json',
      width:1180, height:420,
      projection:{ type:'albersUsa' },
      layer:[
        { data:{ url:'https://vega.github.io/vega-datasets/data/us-10m.json',
                 format:{ type:'topojson', feature:'states' } },
          mark:{ type:'geoshape', fill:'#091120', stroke:'#1f2937' } },
        { data:{ values },
          mark:{ type:'circle', tooltip:true, opacity:0.9, stroke:'#0b1220', strokeWidth:0.6 },
          encoding:{
            longitude:{ field:'lon', type:'quantitative' },
            latitude: { field:'lat', type:'quantitative' },
            size:{ field:'count', type:'quantitative', title:'Sightings',
                   scale:{ type:'sqrt', nice:true, range:[10,900] } },
            color:{ value:'#38bdf8' },
            tooltip:[
              {field:'city', title:'City'},{field:'state', title:'State'},
              {field:'count', type:'quantitative', title:'Reports'},
              {field:'lat', title:'lat'},{field:'lon', title:'lon'}
            ]
          } }
      ],
      config:{ background:null }
    };
    await vegaEmbed('#map', spec, {actions:false});
  }catch(e){
    console.error('Map error:', e);
    setBadge('b-map','failed to load', false);
  }
}

// ---------- 2) ALL sightings HEATMAP (scrubbed.csv) ----------
async function renderHeat(){
  try{
    // default path is repo root; change to "data/scrubbed.csv" if you moved it
    const r = await fetch("scrubbed.csv?v=" + Date.now());
    if (!r.ok) throw new Error(r.status + " " + r.statusText);
    const txt = (await r.text()).trim();

    const lines = txt.split(/\r?\n/);
    const hdr = lines.shift().split(",").map(h=>h.trim().toLowerCase());
    const pos = name => hdr.indexOf(name);
    const iLatNum = pos("lat_num"), iLonNum = pos("lon_num");
    const iLat = iLatNum >= 0 ? iLatNum : pos("latitude");
    const iLon = iLonNum >= 0 ? iLonNum : pos("longitude");

    const pts = lines.map(l=>{
      const c = l.split(",");
      const lat = iLatNum>=0 ? Number(c[iLat]) : smartDeg(c[iLat]);
      const lon = iLonNum>=0 ? Number(c[iLon]) : smartDeg(c[iLon]);
      return {lat, lon};
    }).filter(d => isFinite(d.lat)&&isFinite(d.lon) &&
                    d.lat>=-90&&d.lat<=90 && d.lon>=-180&&d.lon<=180);

    setBadge("b-heat", `parsed ${pts.length} points from scrubbed.csv`);

    const spec = {
      $schema:'https://vega.github.io/schema/vega-lite/v5.json',
      width:1180, height:420,
      projection:{ type:'albersUsa' },
      layer:[
        { data:{ url:'https://vega.github.io/vega-datasets/data/us-10m.json',
                 format:{ type:'topojson', feature:'states' } },
          mark:{ type:'geoshape', fill:'#091120', stroke:'#1f2937' } },
        { data:{ values: pts },
          transform:[
            { bin:true, field:'lon', as:'bx' },
            { bin:true, field:'lat', as:'by' },
            { aggregate:[{op:'count', as:'n'}], groupby:['bx','by'] }
          ],
          mark:{ type:'rect', opacity:0.85 },
          encoding:{
            x:{ field:'bx', type:'quantitative', title:'Longitude' },
            y:{ field:'by', type:'quantitative', title:'Latitude' },
            color:{ field:'n', type:'quantitative', title:'Reports', scale:{ scheme:'blues' } }
          }
        }
      ],
      config:{ background:null }
    };
    await vegaEmbed('#heat', spec, {actions:false});
  }catch(e){
    console.error('Heatmap error:', e);
    setBadge('b-heat','failed to load', false);
  }
}

// ---------- run both ----------
renderMap();
renderHeat();
</script>
</body>
</html>
