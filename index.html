<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>UFO Sightings Explorer — USA Focus</title>
<script src="https://unpkg.com/vega@5"></script>
<script src="https://unpkg.com/vega-lite@5"></script>
<script src="https://unpkg.com/vega-embed@6"></script>
<style>
  :root{--bg:#0f172a;--panel:#0b1220;--stroke:#1f2937;--ink:#e5e7eb;--ok:#a3e635;--okbg:#052e16;--okbd:#14532d;--err:#fecaca;--errbg:#3f1d1d;--errbd:#7f1d1d;--blue:#38bdf8}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.6 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .container{max-width:1220px;margin:auto;padding:24px}
  h1{margin:0 0 8px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .card{background:var(--panel);border:1px solid var(--stroke);border-radius:14px;padding:12px}
  .card h2{margin:0 0 8px;display:flex;align-items:center;gap:8px}
  .badge{font-size:12px;color:var(--ok);background:var(--okbg);border:1px solid var(--okbd);border-radius:999px;padding:2px 8px}
  .badge.err{color:var(--err);background:var(--errbg);border-color:var(--errbd)}
  .viz{min-height:340px}
  .wide{grid-column:1/-1}
  @media (max-width: 900px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="container">
  <h1>UFO Sightings Explorer — USA Focus</h1>
  <p>CSVs can live in <code>/data</code> or the repo root. Badges show what each chart loaded.</p>

  <div class="card wide">
  <h2>UFO sightings by U.S. state</h2>
  <div id="chor" class="viz" style="min-height:420px"></div>
  <p id="chor-desc" style="opacity:.9;margin:.5rem 0 0"></p>
</div>

    <!-- B) CITY BUBBLE MAP (from ufo_cities_latlon.csv) -->
    <div class="card wide">
  <h2>UFO sightings by city (top 300 hotspots)</h2>
  <div id="citiesmap" class="viz" style="min-height:420px"></div>
  <p id="citiesmap-desc" style="opacity:.9;margin:.5rem 0 0"></p>
</div>

    <!-- Other charts -->
    <div class="card wide">
  <h2>Monthly UFO reports in the U.S.</h2>
  <div id="monthly" class="viz"></div>
  <p id="monthly-desc" style="opacity:.9;margin:.5rem 0 0"></p>
</div>

    <div class="card">
      <h2>Hourly rhythm (radial) <span id="b-hourly" class="badge">checking…</span></h2>
      <div id="hourly" class="viz"></div>
    </div>

    <div class="card">
      <h2>Top 10 cities <span id="b-cities" class="badge">checking…</span></h2>
      <div id="cities" class="viz"></div>
    </div>

    <div class="card">
      <h2>Shapes (lollipop) <span id="b-shapes" class="badge">checking…</span></h2>
      <div id="shapes" class="viz"></div>
    </div>

    <div class="card">
      <h2>Yearly trend <span id="b-year" class="badge">checking…</span></h2>
      <div id="yearly" class="viz"></div>
    </div>
  </div>
</div>

<script>
/* ---------- PATHS & HELPERS ---------- */
const PATHS = {
  raw:     ["data/scrubbed.csv","scrubbed.csv","https://gfor009.github.io/FIT3179/scrubbed.csv"],
  citiesLatLon: ["data/ufo_cities_latlon.csv","ufo_cities_latlon.csv"],
  cities:  ["data/ufo_cities.csv","ufo_cities.csv"],
  monthly: ["data/ufo_monthly.csv","ufo_monthly.csv"],
  shapes:  ["data/ufo_shape.csv","ufo_shape.csv"],
  hourly:  ["data/ufo_hourly.csv","ufo_hourly.csv"],
  yearly:  ["data/ufo_year.csv","ufo_year.csv"]
};

async function fetchFirst(paths){
  let lastErr;
  for (const p of paths){
    try{
      const r = await fetch(p + "?v=" + Date.now());
      if(!r.ok) throw new Error(r.status + " " + r.statusText);
      return {url:p, text: await r.text()};
    }catch(e){ lastErr = e; }
  }
  throw lastErr || new Error("All paths failed");
}
function setBadge(id, msg, ok=true){
  const el = document.getElementById(id); if(!el) return;
  el.textContent = msg; el.className = "badge" + (ok ? "" : " err");
}
function smartInt(s){
  const t = String(s ?? '').trim();
  if (/^\d{1,3}([.,\s]\d{3})+$/.test(t)) return Number(t.replace(/[.,\s]/g,''));
  return Number(t.replace(/[,\s]/g,''));
}
function smartDeg(s){
  const t = String(s ?? "").trim();
  const direct = Number(t.replace(',', '.'));
  if (isFinite(direct)) return direct;
  const neg = t.startsWith('-') ? -1 : 1;
  const digits = t.replace(/[^0-9]/g, '');
  if (!digits) return NaN;
  const scale = Math.pow(10, Math.max(7, digits.length - 2));
  return neg * (Number(digits) / scale);
}
function ymKey(s){
  const str = String(s||'').trim();
  let m = str.match(/^\s*(\d{4})[-\/. ]?(\d{1,2})\s*$/);
  if (m) return `${m[1]}-${m[2].padStart(2,'0')}`;
  m = str.match(/(\d{4}).*?(\d{1,2})/);
  if (m) return `${m[1]}-${m[2].padStart(2,'0')}`;
  const names={jan:1,feb:2,mar:3,apr:4,may:5,jun:6,jul:7,aug:8,sep:9,oct:10,nov:11,dec:12};
  const m2=str.match(/\b(jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec)[a-z]*\b.*?(\d{4})/i);
  if(m2) return `${m2[2]}-${String(names[m2[1].toLowerCase()]).padStart(2,'0')}`;
  return null;
}
const BLUE = '#38bdf8';

/* ---------- A) STATE CHOROPLETH ---------- */
async function renderStateChoropleth(){
  try{
    const topo = {
      url:'https://vega.github.io/vega-datasets/data/us-10m.json',
      format:{ type:'topojson', feature:'states' }
    };
    const FIPS = [
      ["AL",1],["AK",2],["AZ",4],["AR",5],["CA",6],["CO",8],["CT",9],["DE",10],["DC",11],
      ["FL",12],["GA",13],["HI",15],["ID",16],["IL",17],["IN",18],["IA",19],["KS",20],
      ["KY",21],["LA",22],["ME",23],["MD",24],["MA",25],["MI",26],["MN",27],["MS",28],
      ["MO",29],["MT",30],["NE",31],["NV",32],["NH",33],["NJ",34],["NM",35],["NY",36],
      ["NC",37],["ND",38],["OH",39],["OK",40],["OR",41],["PA",42],["RI",44],["SC",45],
      ["SD",46],["TN",47],["TX",48],["UT",49],["VT",50],["VA",51],["WA",53],["WV",54],
      ["WI",55],["WY",56]
    ];
    const fipsMap = new Map(FIPS);

    const {url, text} = await fetchFirst(PATHS.raw);
    const first = (text.split(/\r?\n/)[0]||'');
    const delim = first.includes(';')?';':',';
    const rows = text.trim().split(/\r?\n/).filter(Boolean).map(r=>r.split(delim));
    const head = rows.shift().map(h=>h.trim().toLowerCase());
    const idx = n => head.indexOf(n);
    const iCountry = idx('country');
    const iState = Math.max(idx('state'), idx('state/province'));
    if (iCountry<0 || iState<0) throw new Error('Missing country/state in scrubbed.csv');

    const byState = new Map();
    for (const r of rows){
      if ((r[iCountry]||'').trim().toLowerCase() !== 'us') continue;
      const abbr = (r[iState]||'').trim().toUpperCase();
      if (!fipsMap.has(abbr)) continue;
      byState.set(abbr, (byState.get(abbr)||0) + 1);
    }
    const counts = [];
    for (const [abbr,n] of byState) counts.push({id:fipsMap.get(abbr), abbr, count:n});

    // === Write a short description (top/bottom states) ===
    const fmt = new Intl.NumberFormat('en-US').format;
    const sorted = counts.slice().sort((a,b)=>b.count-a.count);
    const top = sorted.slice(0,3).map(d=>`${d.abbr} (${fmt(d.count)})`).join(', ');
    const bottom = sorted.slice(-3).map(d=>`${d.abbr} (${fmt(d.count)})`).join(', ');
    const total = counts.reduce((s,d)=>s+d.count,0);
    const descEl = document.getElementById('chor-desc');
    if (descEl){
      descEl.textContent =
        `Each state is coloured by its total number of UFO reports. The dataset totals ${fmt(total)} U.S. sightings. ` +
        `Highest: ${top}. Lowest: ${bottom}. Larger, more populous states tend to report more sightings.`;
    }

    // (Remove the old green pill, if still present)
    document.getElementById('b-chor')?.remove();

    const spec = {
      $schema:'https://vega.github.io/schema/vega-lite/v5.json',
      width:1180, height:420,
      data: topo,
      transform:[{
        lookup:'id',
        from:{ data:{ values:counts }, key:'id', fields:['count','abbr'] }
      }],
      mark:{ type:'geoshape', stroke:'#98a0ab', strokeWidth:0.7 },
      encoding:{
        color:{
          field:'count', type:'quantitative',
          title:'Total sightings',
          scale:{ scheme:'blues' },
          legend:{
            orient:'right',
            gradientLength:240,
            tickCount:6,
            format:',d',
            titleFontSize:12,
            labelFontSize:11,
            // make legend text white to match the dark theme
            titleColor:'#e5e7eb',
            labelColor:'#e5e7eb'
          }
        },
        tooltip:[
          { field:'abbr', title:'State' },
          { field:'count', type:'quantitative', title:'Sightings', format:',d' }
        ]
      },
      projection:{ type:'albersUsa' },
      config:{ background:null }
    };

    await vegaEmbed('#chor', spec, {actions:false});
  }catch(e){
    console.error('Choropleth error:', e);
  }
}

/* ---------- B) CITY BUBBLE MAP (from ufo_cities_latlon.csv) ---------- */
async function renderMapFromCities(){
  try{
    const topo = { url:'https://vega.github.io/vega-datasets/data/us-10m.json',
                   format:{ type:'topojson', feature:'states' } };

    const {url, text} = await fetchFirst(PATHS.citiesLatLon);
    const first = (text.split(/\r?\n/)[0]||''); 
    const delim = first.includes(';') ? ';' : ',';
    const rows = text.trim().split(/\r?\n/).filter(Boolean).map(r=>r.split(delim));
    const head = rows.shift().map(h=>h.trim().toLowerCase());
    const pick = (...names)=> names.map(n=>head.indexOf(n)).find(i=>i>=0);

    const iCity = pick('city');
    const iState = pick('state','region');
    const iCountry = pick('country');
    const iLat = pick('latitude','lat');
    const iLon = pick('longitude','lon','lng','long');
    const iCnt = pick('count','sightings','total','value');
    if ([iCity,iState,iCountry,iLat,iLon,iCnt].some(i=>i===undefined)) throw new Error('Missing columns');

    // group duplicates city|state and sum counts
    const byKey = new Map();
    for (const r of rows){
      if ((r[iCountry]||'').trim().toLowerCase() !== 'us') continue;
      const city = (r[iCity]||'').trim();
      const state = (r[iState]||'').trim();
      const lat = smartDeg((r[iLat]||'').replace(',', '.'));
      const lon = smartDeg((r[iLon]||'').replace(',', '.'));
      const count = smartInt(r[iCnt]);
      if (!isFinite(lat)||!isFinite(lon)||!isFinite(count)) continue;
      if (lat < 18 || lat > 72 || lon > -60 || lon < -170) continue;

      const key = city.toLowerCase()+'|'+state.toLowerCase();
      const cur = byKey.get(key) || {city, state, latSum:0, lonSum:0, n:0, count:0};
      cur.latSum += lat; cur.lonSum += lon; cur.n += 1; cur.count += count;
      byKey.set(key, cur);
    }

    let values = [...byKey.values()].map(d=>({
      city:d.city, state:d.state, lat:d.latSum/d.n, lon:d.lonSum/d.n, count:d.count
    }));
    values.sort((a,b)=>b.count-a.count);
    values = values.slice(0, 300); // top 300 for readability

    // write a short paragraph from the data (top cities)
    const fmt = new Intl.NumberFormat('en-US').format;
    const top5 = values.slice(0,5).map(d => `${d.city}, ${d.state} (${fmt(d.count)})`).join(', ');
    const totalTop = values.reduce((s,d)=>s+d.count,0);
    const desc = document.getElementById('citiesmap-desc');
    if (desc) {
      desc.textContent =
        `Each bubble marks a city; bubble size encodes total reports. ` +
        `This view shows the top 300 cities by sightings (covering ${fmt(totalTop)} reports). ` +
        `Leaders include: ${top5}.`;
    }

    // cap bubble sizes at the 99th percentile (robust to outliers)
    const counts = values.map(d=>d.count).filter(n=>n>0).sort((a,b)=>a-b);
    const q99 = counts.length ? counts[Math.floor(0.99*(counts.length-1))] : 1;
    const domainMax = Math.max(1, q99);

    const spec = {
      $schema:'https://vega.github.io/schema/vega-lite/v5.json',
      width:1180, height:420,
      projection:{ type:'albersUsa' },
      layer:[
        { data: topo, mark:{ type:'geoshape', fill:'#091120', stroke:'#98a0ab' } },
        { data:{ values },
          transform:[ {calculate:`min(datum.count, ${domainMax})`, as:'count_capped'} ],
          mark:{ type:'circle', opacity:0.85, stroke:'#0b1220', strokeWidth:0.5, tooltip:true },
          encoding:{
            longitude:{ field:'lon', type:'quantitative' },
            latitude: { field:'lat', type:'quantitative' },
            size:{
              field:'count_capped', type:'quantitative',
              scale:{ type:'sqrt', domain:[0, domainMax], clamp:true, range:[10,800] },
              title:'City sightings',
              legend:{
                orient:'right',
                format:',d',
                labelColor:'#e5e7eb',   // white-ish labels on dark
                titleColor:'#e5e7eb',
                symbolStrokeColor:'#0b1220',
                symbolStrokeWidth:0.6
              }
            },
            color:{ value:'#38bdf8' },
            tooltip:[
              {field:'city', title:'City'},
              {field:'state', title:'State'},
              {field:'count', type:'quantitative', title:'Reports', format:',d'}
            ]
          }
        }
      ],
      config:{ background:null }
    };

    await vegaEmbed('#citiesmap', spec, {actions:false});

    // if any old badge span exists, remove it
    document.getElementById('b-citiesmap')?.remove();

  }catch(e){
    console.error('Cities map error:', e);
  }
}

/* ---------- OTHER CHARTS (unchanged) ---------- */
async function renderMonthly(){
  try{
    // --- try the monthly CSV first ---
    const tryMonthly = async ()=>{
      const {url, text} = await fetchFirst(PATHS.monthly);
      const first = (text.split(/\r?\n/)[0]||'');
      const delim = first.includes('\t') ? '\t' : (first.includes(';') ? ';' : ',');
      const rows = text.trim().split(/\r?\n/).filter(Boolean).map(r=>r.split(delim));
      const head = (rows.shift()||[]).map(h=>h.trim().toLowerCase());
      const find = (names)=>{ for(const n of names){ const i=head.indexOf(n); if(i>=0) return i; } return -1; };
      const iM = find(['month','date']), iC = find(['count','total','value','sightings']);
      if (iM < 0 || iC < 0) return { url, values: [] };
      const values = rows.map(r=>{
        const k = ymKey(r[iM]); const c = smartInt(r[iC]);
        return (k && Number.isFinite(c)) ? { date:new Date(k+'-01'), count:c } : null;
      }).filter(Boolean).sort((a,b)=>a.date-b.date);
      return { url, values };
    };

    // --- fallback: build months from raw scrubbed.csv ---
    const buildFromRaw = async ()=>{
      const {url, text} = await fetchFirst(PATHS.raw);
      const first = (text.split(/\r?\n/)[0]||''); const delim = first.includes(';')?';':',';
      const rows = text.trim().split(/\r?\n/).filter(Boolean).map(r=>r.split(delim));
      const head = (rows.shift()||[]).map(h=>h.trim().toLowerCase());
      const idx = n => head.indexOf(n);
      const iCountry = idx('country');
      const iDT = [idx('datetime'), idx('date_time'), idx('date'), idx('occurred'), idx('sighted_at')]
                    .reduce((a,b)=>a>=0?a:b, -1);
      if (iDT < 0) return { url, values: [] };
      const byYM = new Map();
      for (const r of rows){
        if (iCountry >= 0 && (r[iCountry]||'').trim().toLowerCase() !== 'us') continue;
        const k = ymKey(r[iDT]); if (!k) continue;
        byYM.set(k, (byYM.get(k)||0) + 1);
      }
      const values = [...byYM.entries()]
        .map(([k,c])=>({ date:new Date(k+'-01'), count:c }))
        .sort((a,b)=>a.date-b.date);
      return { url, values };
    };

    let {url, values} = await tryMonthly();
    if (!values.length){ const built = await buildFromRaw(); url = built.url; values = built.values; setBadge("b-monthly", `built ${values.length} months from ${url}`); }
    else { setBadge("b-monthly", `loaded ${values.length} rows from ${url}`); }

    if (!values.length){
      document.getElementById('monthly').innerHTML = '<p style="opacity:.75">No valid monthly data found.</p>';
      return;
    }

    // compute 12-month moving average
    const mv = [];
    let run = 0;
    for (let i=0;i<values.length;i++){
      run += values[i].count;
      if (i>=12) run -= values[i-12].count;
      mv.push({ date: values[i].date, avg12: (i>=11) ? run/12 : null });
    }

    // stats for paragraph
    const fmt = new Intl.NumberFormat('en-US').format;
    const firstDate = values[0].date, lastDate = values[values.length-1].date;
    const total = values.reduce((s,d)=>s+d.count,0);
    const peak = values.reduce((a,b)=> b.count>a.count?b:a, values[0]);

    // write paragraph
    const p = document.getElementById('monthly-desc');
    if (p){
      const span = `${firstDate.getFullYear()}–${lastDate.getFullYear()}`;
      p.textContent = `Monthly UFO reports show a long, low baseline through mid-century, rising sharply from the late 1990s into the 2000s. `
        + `This series spans ${span}, totalling ${fmt(total)} reports. The single highest month is `
        + `${peak.date.toLocaleString('en-US',{year:'numeric',month:'short'})} with ${fmt(peak.count)} reports. `
        + `The 12-month average (line) smooths out seasonal spikes.`;
    }

    // render chart (full width, readable axes, white labels)
    const spec = {
      $schema:'https://vega.github.io/schema/vega-lite/v5.json',
      width:1180, height:360,
      data:{ values },
      layer:[
        { mark:{ type:'area', opacity:0.12, color:BLUE },
          encoding:{ x:{field:'date',type:'temporal',title:'Month', axis:{labelColor:'#e5e7eb', titleColor:'#e5e7eb'}},
                     y:{field:'count',type:'quantitative',title:'Sightings', axis:{labelColor:'#e5e7eb', titleColor:'#e5e7eb'}} } },
        { mark:{ type:'line', color:BLUE, strokeWidth:1.2 },
          encoding:{ x:{field:'date',type:'temporal'}, y:{field:'count',type:'quantitative'} } },
        { mark:{ type:'point', color:BLUE, opacity:0.5, size:12 },
          encoding:{ x:{field:'date',type:'temporal'}, y:{field:'count',type:'quantitative'},
                     tooltip:[{field:'date',type:'temporal',title:'Month'},{field:'count',type:'quantitative',title:'Reports'}] } },
        { data:{ values: mv.filter(d=>d.avg12!=null) },
          mark:{ type:'line', color:'#9dd6ff', strokeWidth:2 },
          encoding:{ x:{field:'date',type:'temporal'}, y:{field:'avg12',type:'quantitative', title:'12-mo average'} } }
      ],
      config:{ background:null, axis:{gridColor:'#1f2937'} }
    };
    await vegaEmbed('#monthly', spec, {actions:false});
  }catch(e){
    console.error('Monthly error:', e);
    setBadge('b-monthly','failed to load', false);
  }
}
async function renderHourly(){
  try{
    const {url,text} = await fetchFirst(PATHS.hourly);
    const delim = (text.split(/\r?\n/)[0]||'').includes(';') ? ';' : ',';
    const rows = text.trim().split(/\r?\n/).filter(Boolean).map(r=>r.split(delim));
    const head = rows.shift().map(h=>h.trim().toLowerCase());
    const iH=head.indexOf("hour"), iC = Math.max(head.indexOf("count"), head.indexOf("total"));
    const values = rows.map(c=>({hour:+c[iH], count:smartInt(c[iC])})).filter(d=>isFinite(d.hour)&&isFinite(d.count));
    setBadge("b-hourly", `loaded ${values.length} rows from ${url}`);
    const spec = {$schema:'https://vega.github.io/schema/vega-lite/v5.json', width:560,height:340,data:{values},
      transform:[{calculate:'format(datum.hour,"02")', as:'hlabel'}],
      mark:{type:'arc',innerRadius:90,stroke:'#0b1220'},
      encoding:{theta:{field:'count',type:'quantitative',stack:true,title:'Reports'},
                color:{field:'hlabel',type:'nominal',legend:{title:'Hour (00–23)',orient:'bottom',columns:6,labelLimit:160}},
                tooltip:[{field:'hour',title:'Hour'},{field:'count',type:'quantitative'}]},
      config:{legend:{orient:'bottom'}}};
    await vegaEmbed('#hourly', spec, {actions:false});
  }catch(e){ console.error('Hourly error:', e); setBadge('b-hourly','failed to load', false); }
}
async function renderCities(){
  try{
    const {url,text} = await fetchFirst(PATHS.cities);
    const delim = (text.split(/\r?\n/)[0]||'').includes(';') ? ';' : ',';
    const rows = text.trim().split(/\r?\n/).filter(Boolean).map(r=>r.split(delim));
    const head = rows.shift().map(h=>h.trim().toLowerCase());
    const iCity=head.indexOf("city"), iC=Math.max(head.indexOf("count"), head.indexOf("total"));
    const values = rows.map(c=>({ city:(c[iCity]||'').toLowerCase().trim(), count:smartInt(c[iC]) }))
                       .filter(r=>r.city && isFinite(r.count)).sort((a,b)=>b.count-a.count).slice(0,10);
    setBadge("b-cities", `loaded ${values.length} rows from ${url}`);
    const spec = {$schema:'https://vega.github.io/schema/vega-lite/v5.json', width:560,height:340,data:{values},
      mark:{type:'bar',tooltip:true},
      encoding:{y:{field:'city',type:'nominal',sort:'-x',title:'City'}, x:{field:'count',type:'quantitative',title:'Reports'}},
      config:{background:null}};
    await vegaEmbed('#cities', spec, {actions:false});
  }catch(e){ console.error('Cities error:', e); setBadge('b-cities','failed to load', false); }
}
async function renderShapes(){
  try{
    const {url,text} = await fetchFirst(PATHS.shapes);
    const delim = (text.split(/\r?\n/)[0]||'').includes(';') ? ';' : ',';
    const rows = text.trim().split(/\r?\n/).filter(Boolean).map(r=>r.split(delim));
    const head = rows.shift().map(h=>h.trim().toLowerCase());
    const iS=head.indexOf("shape"), iC=Math.max(head.indexOf("count"), head.indexOf("total"));
    const values = rows.map(c=>({ shape:(c[iS]||'').toLowerCase().trim(), count:smartInt(c[iC]) })).filter(r=>r.shape && isFinite(r.count));
    setBadge("b-shapes", `loaded ${values.length} rows from ${url}`);
    const spec = {$schema:'https://vega.github.io/schema/vega-lite/v5.json', width:560,height:340,data:{values},
      layer:[
        { mark:{type:'rule', stroke:'#64748b', strokeWidth:2},
          encoding:{ y:{field:'shape',type:'nominal',sort:'-x',title:'Shape'}, x:{field:'count',type:'quantitative',title:'Reports'}, x2:{value:0} } },
        { mark:{type:'point', filled:true, size:80, color:BLUE},
          encoding:{ y:{field:'shape', type:'nominal', sort:'-x'},
                     x:{field:'count', type:'quantitative'},
                     tooltip:[{field:'shape'},{field:'count',type:'quantitative',title:'Reports'}] } }
      ],
      config:{background:null}};
    await vegaEmbed('#shapes', spec, {actions:false});
  }catch(e){ console.error('Shapes error:', e); setBadge('b-shapes','failed to load', false); }
}
async function renderYearly(){
  try{
    const {url,text} = await fetchFirst(PATHS.yearly);
    const delim = (text.split(/\r?\n/)[0]||'').includes(';') ? ';' : ',';
    const rows = text.trim().split(/\r?\n/).filter(Boolean).map(r=>r.split(delim));
    const head = rows.shift().map(h=>h.trim().toLowerCase());
    const iY=head.indexOf("year"), iC=Math.max(head.indexOf("count"), head.indexOf("total"));
    const values = rows.map(c=>({year:+c[iY], count:smartInt(c[iC])})).filter(d=>Number.isFinite(d.year)&&Number.isFinite(d.count));
    setBadge("b-year", `loaded ${values.length} rows from ${url}`);
    const spec = {$schema:'https://vega.github.io/schema/vega-lite/v5.json', width:560,height:340,data:{values},
      mark:{type:'line', point:true, color:BLUE},
      encoding:{ x:{field:'year',type:'quantitative',title:'Year'}, y:{field:'count',type:'quantitative',title:'Sightings'} },
      config:{background:null}};
    await vegaEmbed('#yearly', spec, {actions:false});
  }catch(e){ console.error('Yearly error:', e); setBadge('b-year','failed to load', false); }
}

/* ---------- RUN ALL ---------- */
Promise.all([
  renderStateChoropleth(),
  renderMapFromCities(),
  renderMonthly(),
  renderHourly(),
  renderCities(),
  renderShapes(),
  renderYearly()
]);
</script>
</body>
</html>
