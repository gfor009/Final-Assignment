<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>UFO Sightings Explorer — USA Focus</title>
<script src="https://unpkg.com/vega@5"></script>
<script src="https://unpkg.com/vega-lite@5"></script>
<script src="https://unpkg.com/vega-embed@6"></script>
<style>
  body{margin:0;background:#0f172a;color:#e5e7eb;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .container{max-width:1200px;margin:auto;padding:24px}
  h1{margin:0 0 8px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .card{background:#0b1220;border:1px solid #1f2937;border-radius:14px;padding:12px}
  .card h2{margin:0 0 8px;display:flex;align-items:center;gap:8px}
  .badge{font-size:12px;color:#a3e635;background:#052e16;border:1px solid #14532d;border-radius:999px;padding:2px 8px}
  .badge.err{color:#fecaca;background:#3f1d1d;border:1px solid #7f1d1d}
  .viz{min-height:340px}
  @media (max-width:900px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="container">
  <h1>UFO Sightings Explorer — USA Focus</h1>
  <p>This page auto-finds your CSVs in <code>/data</code> or the repo root, and shows a badge with what it loaded.</p>

  <div class="grid">
    <div class="card">
      <h2>Top cities (bar chart) <span id="b-cities" class="badge">checking…</span></h2>
      <div id="cities" class="viz"></div>
    </div>
    <div class="card">
      <h2>Monthly trend <span id="b-monthly" class="badge">checking…</span></h2>
      <div id="monthly" class="viz"></div>
    </div>
    <div class="card">
      <h2>Shapes (overall) <span id="b-shapes" class="badge">checking…</span></h2>
      <div id="shapes" class="viz"></div>
    </div>
    <div class="card">
      <h2>Sightings by hour <span id="b-hourly" class="badge">checking…</span></h2>
      <div id="hourly" class="viz"></div>
    </div>
  </div>
</div>

<script>
/* ---------- Paths & helpers ---------- */
const PATHS = {
  cities:  ["data/ufo_cities.csv", "ufo_cities.csv"],          // city;count
  monthly: ["data/ufo_monthly.csv","ufo_monthly.csv"],         // month;count
  shapes:  ["data/ufo_shape.csv",  "ufo_shape.csv"],           // shape;count
  hourly:  ["data/ufo_hourly.csv", "ufo_hourly.csv"]           // hour;count
};

// Try multiple URLs (data/ then root), add cache-buster
async function fetchFirst(paths){
  let lastErr;
  for (const p of paths){
    const url = p + "?v=" + Date.now();
    try {
      const res = await fetch(url);
      if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
      const txt = await res.text();
      return {url:p, text:txt};
    } catch(e){ lastErr = e; }
  }
  throw lastErr || new Error("All paths failed");
}

// Semicolon CSV -> array of objects
function parseSemi(text){
  const lines = text.trim().split(/\r?\n/).filter(Boolean);
  if (lines.length < 2) return [];
  const headers = lines[0].split(";").map(h=>h.trim());
  return lines.slice(1).map(line=>{
    const cells = line.split(";");
    const row = {};
    headers.forEach((h,i)=> row[h] = (cells[i]??"").trim());
    return row;
  });
}

function setBadge(id, msg, ok=true){
  const el = document.getElementById(id);
  if(!el) return;
  el.textContent = msg;
  el.className = "badge" + (ok ? "" : " err");
}

/* ---------- Renderers ---------- */

// 1) Top Cities (city;count)
async function renderCities(){
  try{
    const {url,text} = await fetchFirst(PATHS.cities);
    const rows = parseSemi(text);
    const values = rows
      .map(r => ({ city: (r.city||"").toLowerCase().trim(), count: +r.count }))
      .filter(r => r.city && Number.isFinite(r.count))
      .sort((a,b)=> b.count - a.count)
      .slice(0,30);
    setBadge("b-cities", `loaded ${values.length} rows from ${url}`);
    const spec = {
      $schema:"https://vega.github.io/schema/vega-lite/v5.json",
      width:560,height:340,
      data:{ values },
      mark:{ type:"bar", tooltip:true },
      encoding:{
        y:{ field:"city", type:"nominal", sort:"-x", title:"City" },
        x:{ field:"count", type:"quantitative", title:"Reports" },
        tooltip:[{field:"city",title:"City"},{field:"count",type:"quantitative",title:"Reports"}]
      }
    };
    return vegaEmbed("#cities", spec, {actions:false});
  }catch(e){
    console.error("Cities load error:", e);
    setBadge("b-cities", "failed to load", false);
  }
}

// 2) Monthly (month;count)
async function renderMonthly(){
  try{
    const {url,text} = await fetchFirst(PATHS.monthly);
    const rows = parseSemi(text);
    const values = rows.map(r=>{
      // allow 1990-01-01 or 1/1/1990
      const s = (r.month||"").replace(/\./g,"-").replace(/\//g,"-");
      const d = new Date(s);
      return { month:d, count:+r.count };
    }).filter(r => !isNaN(r.month.getTime()) && Number.isFinite(r.count));
    setBadge("b-monthly", `loaded ${values.length} rows from ${url}`);
    const spec = {
      $schema:"https://vega.github.io/schema/vega-lite/v5.json",
      width:560,height:340,
      data:{ values },
      mark:{ type:"line", point:true },
      encoding:{
        x:{ field:"month", type:"temporal", title:"Month" },
        y:{ field:"count", type:"quantitative", title:"Sightings" },
        color:{ value:"#38bdf8" }
      }
    };
    return vegaEmbed("#monthly", spec, {actions:false});
  }catch(e){
    console.error("Monthly load error:", e);
    setBadge("b-monthly", "failed to load", false);
  }
}

// 3) Shapes (shape;count)
async function renderShapes(){
  try{
    const {url,text} = await fetchFirst(PATHS.shapes);
    const rows = parseSemi(text);
    const values = rows
      .map(r => ({ shape:(r.shape||"").toLowerCase().trim(), count:+r.count }))
      .filter(r => r.shape && Number.isFinite(r.count));
    setBadge("b-shapes", `loaded ${values.length} rows from ${url}`);
    const spec = {
      $schema:"https://vega.github.io/schema/vega-lite/v5.json",
      width:560,height:340,
      data:{ values },
      mark:{ type:"bar", tooltip:true },
      encoding:{
        y:{ field:"shape", type:"nominal", sort:"-x", title:"Shape" },
        x:{ field:"count", type:"quantitative", title:"Reports" }
      }
    };
    return vegaEmbed("#shapes", spec, {actions:false});
  }catch(e){
    console.error("Shapes load error:", e);
    setBadge("b-shapes", "failed to load", false);
  }
}

// 4) Hourly (hour;count)
async function renderHourly(){
  try{
    const {url,text} = await fetchFirst(PATHS.hourly);
    const rows = parseSemi(text);
    const values = rows
      .map(r => ({ hour:+r.hour, count:+r.count }))
      .filter(r => Number.isFinite(r.hour) && Number.isFinite(r.count));
    setBadge("b-hourly", `loaded ${values.length} rows from ${url}`);
    const spec = {
      $schema:"https://vega.github.io/schema/vega-lite/v5.json",
      width:560,height:340,
      data:{ values },
      mark:{ type:"bar", tooltip:true },
      encoding:{
        x:{ field:"hour", type:"ordinal", title:"Hour (0–23)", sort:"ascending" },
        y:{ field:"count", type:"quantitative", title:"Reports" }
      }
    };
    return vegaEmbed("#hourly", spec, {actions:false});
  }catch(e){
    console.error("Hourly load error:", e);
    setBadge("b-hourly", "failed to load", false);
  }
}

Promise.all([renderCities(), renderMonthly(), renderShapes(), renderHourly()]);
</script>
</body>
</html>
