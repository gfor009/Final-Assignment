<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>UFO Sightings Explorer — USA Focus</title>
<script src="https://unpkg.com/vega@5"></script>
<script src="https://unpkg.com/vega-lite@5"></script>
<script src="https://unpkg.com/vega-embed@6"></script>
<style>
  :root{--bg:#0f172a;--panel:#0b1220;--stroke:#1f2937;--ink:#e5e7eb;--ok:#a3e635;--okbg:#052e16;--okbd:#14532d;--err:#fecaca;--errbg:#3f1d1d;--errbd:#7f1d1d;--blue:#38bdf8}
  html,body{height:100%} body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.6 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .container{max-width:1220px;margin:auto;padding:24px}
  h1{margin:0 0 8px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .card{background:var(--panel);border:1px solid var(--stroke);border-radius:14px;padding:12px}
  .card h2{margin:0 0 8px;display:flex;align-items:center;gap:8px}
  .badge{font-size:12px;color:var(--ok);background:var(--okbg);border:1px solid var(--okbd);border-radius:999px;padding:2px 8px}
  .badge.err{color:var(--err);background:var(--errbg);border-color:var(--errbd)}
  .viz{min-height:340px}
  .wide{grid-column:1/-1}
  @media (max-width: 900px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="container">
  <h1>UFO Sightings Explorer — USA Focus</h1>
  <p>This page finds your CSVs in <code>/data</code> or the repo root and shows a status badge per chart.</p>

  <div class="grid">
    <div class="card wide">
      <h2>US city hotspots (map) <span id="b-map" class="badge">checking…</span></h2>
      <div id="map" class="viz" style="min-height:420px"></div>
    </div>

    <div class="card wide">
      <h2>All sightings (binned heatmap) <span id="b-heat" class="badge">checking…</span></h2>
      <div id="heat" class="viz" style="min-height:420px"></div>
    </div>

    <div class="card">
      <h2>Monthly trend (line + area) <span id="b-monthly" class="badge">checking…</span></h2>
      <div id="monthly" class="viz"></div>
    </div>

    <div class="card">
      <h2>Hourly rhythm (radial donut) <span id="b-hourly" class="badge">checking…</span></h2>
      <div id="hourly" class="viz"></div>
    </div>

    <div class="card">
      <h2>Top cities (bar) <span id="b-cities" class="badge">checking…</span></h2>
      <div id="cities" class="viz"></div>
    </div>

    <div class="card">
      <h2>Shapes (bar) <span id="b-shapes" class="badge">checking…</span></h2>
      <div id="shapes" class="viz"></div>
    </div>
  </div>
</div>

<script>
/* ---------- paths & helpers ---------- */
const PATHS = {
  // map
  citiesLatLon: ["data/ufo_cities_latlon.csv","ufo_cities_latlon.csv"], // city,state,country,latitude,longitude,count
  // aggregates (semicolon)
  cities:  ["data/ufo_cities.csv","ufo_cities.csv"],        // city;count
  monthly: ["data/ufo_monthly.csv","ufo_monthly.csv"],      // month;count
  shapes:  ["data/ufo_shape.csv","ufo_shape.csv"],          // shape;count
  hourly:  ["data/ufo_hourly.csv","ufo_hourly.csv"],        // hour;count
  // raw
  scrubbed: ["scrubbed.csv","data/scrubbed.csv"]            // one row per sighting
};

async function fetchFirst(paths){
  let lastErr;
  for (const p of paths){
    try{
      const r = await fetch(p + "?v=" + Date.now());
      if(!r.ok) throw new Error(r.status + " " + r.statusText);
      return {url:p, text: await r.text()};
    }catch(e){ lastErr = e; }
  }
  throw lastErr || new Error("All paths failed");
}

function setBadge(id, msg, ok=true){
  const el = document.getElementById(id); if(!el) return;
  el.textContent = msg; el.className = "badge" + (ok ? "" : " err");
}

// dotted coords like "401.947.222" -> 40.1947222
function smartDeg(s){
  const t = String(s ?? "").trim();
  const direct = Number(t.replace(',', '.'));
  if (isFinite(direct)) return direct;
  const neg = t.startsWith('-') ? -1 : 1;
  const digits = t.replace(/[^0-9]/g, '');
  if (!digits) return NaN;
  const scale = Math.pow(10, Math.max(7, digits.length - 2));
  return neg * (Number(digits) / scale);
}
// integer from "2,345" / "2.345" / "2 345"
function smartInt(s){
  const t = String(s ?? '').trim();
  if (/^\d{1,3}([.,\s]\d{3})+$/.test(t)) return Number(t.replace(/[.,\s]/g,''));
  return Number(t.replace(/[,\s]/g,''));
}
// parse YYYY-MM from many strings
function ymKey(s){
  const m = String(s||"").match(/(\d{4}).*?(\d{1,2})/);
  if(!m) return null; return `${m[1]}-${m[2].padStart(2,'0')}`;
}
</script>

<script>
/* ---------- 1) MAP (city bubbles) ---------- */
async function renderMap(){
  try{
    const topo = { url:'https://vega.github.io/vega-datasets/data/us-10m.json',
                   format:{ type:'topojson', feature:'states' } };

    const {url,text} = await fetchFirst(PATHS.citiesLatLon);
    const lines = text.replace(/;/g,",").trim().split(/\r?\n/).filter(Boolean);
    const headers = lines.shift().split(",").map(h=>h.trim().toLowerCase());
    const at = (names)=>{const L=headers; for(const n of names){const i=L.indexOf(n.toLowerCase()); if(i>=0) return i;} return -1;};

    const iCity = at(["city"]), iState=at(["state","region"]),
          iLat=at(["latitude","lat"]), iLon=at(["longitude","lon","lng","long"]),
          iCnt=at(["count","sightings","value","total"]);

    const values = lines.map(l=>{
      const c=l.split(",");
      let lat=smartDeg(c[iLat]), lon=smartDeg(c[iLon]);
      if (Math.abs(lon) < 30 && Math.abs(lat) > 30) { const t=lat; lat=lon; lon=t; } // swap if obviously flipped
      return {
        city:(c[iCity]||"").trim(),
        state:(c[iState]||"").trim(),
        lat, lon, count: smartInt(c[iCnt])
      };
    }).filter(d=>isFinite(d.lat)&&isFinite(d.lon)&&isFinite(d.count)&&d.lat>=-90&&d.lat<=90&&d.lon>=-180&&d.lon<=180);

    setBadge("b-map", `loaded ${values.length} rows from ${url}`);

    const spec = {
      $schema:'https://vega.github.io/schema/vega-lite/v5.json',
      width:1180, height:420,
      projection:{ type:'albersUsa' },
      layer:[
        { data:topo, mark:{ type:'geoshape', fill:'#091120', stroke:'#1f2937' } },
        { data:{ values },
          mark:{ type:'circle', tooltip:true, opacity:0.9, stroke:'#0b1220', strokeWidth:0.6 },
          encoding:{
            longitude:{ field:'lon', type:'quantitative' },
            latitude:{ field:'lat', type:'quantitative' },
            size:{ field:'count', type:'quantitative', title:'Sightings',
                   scale:{ type:'sqrt', nice:true, range:[10,900] } },
            color:{ value:'#38bdf8' },
            tooltip:[
              {field:'city', title:'City'},{field:'state', title:'State'},
              {field:'count', type:'quantitative', title:'Reports'},
              {field:'lat', title:'lat'},{field:'lon', title:'lon'}
            ]
          } }
      ],
      config:{ background:null }
    };
    await vegaEmbed('#map', spec, {actions:false});
  }catch(e){
    console.error('Map error:', e);
    setBadge('b-map','failed to load', false);
  }
}

/* ---------- 2) ALL sightings HEATMAP (point density) ---------- */
async function renderHeat(){
  try{
    const {url,text} = await fetchFirst(PATHS.scrubbed);
    const lines = text.trim().split(/\r?\n/);
    const hdr = lines.shift().split(",").map(h=>h.trim().toLowerCase());
    const pos = n => hdr.indexOf(n);

    const iLatNum = pos("lat_num"), iLonNum = pos("lon_num");
    const iLat = iLatNum>=0 ? iLatNum : pos("latitude");
    const iLon = iLonNum>=0 ? iLonNum : pos("longitude");

    let pts = lines.map(l=>{
      const c = l.split(",");
      const lat = iLatNum>=0 ? Number(c[iLat]) : smartDeg(c[iLat]);
      const lon = iLonNum>=0 ? Number(c[iLon]) : smartDeg(c[iLon]);
      return {lat, lon};
    }).filter(d=>isFinite(d.lat)&&isFinite(d.lon)&&d.lat>=-90&&d.lat<=90&&d.lon>=-180&&d.lon<=180);

    // mild downsample for perf
    if (pts.length > 40000) {
      const step = Math.ceil(pts.length / 40000);
      pts = pts.filter((_,i)=> i % step === 0);
    }

    setBadge("b-heat", `parsed ${pts.length} points from ${url}`);

    const spec = {
      $schema:'https://vega.github.io/schema/vega-lite/v5.json',
      width:1180, height:420,
      projection:{ type:'albersUsa' },
      layer:[
        { data:{ url:'https://vega.github.io/vega-datasets/data/us-10m.json',
                 format:{ type:'topojson', feature:'states' } },
          mark:{ type:'geoshape', fill:'#091120', stroke:'#1f2937' } },
        { data:{ values: pts },
          mark:{ type:'circle', opacity:0.06, size:8, tooltip:false },
          encoding:{
            longitude:{ field:'lon', type:'quantitative' },
            latitude: { field:'lat', type:'quantitative' },
            color:{ value:'#60a5fa' }
          }
        }
      ],
      config:{ background:null }
    };
    await vegaEmbed('#heat', spec, {actions:false});
  }catch(e){
    console.error('Heatmap error:', e);
    setBadge('b-heat','failed to load', false);
  }
}

/* ---------- 3) MONTHLY trend ---------- */
async function renderMonthly(){
  try{
    const {url,text} = await fetchFirst(PATHS.monthly);
    const rows = text.trim().split(/\r?\n/).map(r=>r.split(";"));
    const head = rows.shift().map(h=>h.trim().toLowerCase());
    const iM = head.indexOf("month"), iC = head.indexOf("count");
    const values = rows.map(c=>{
      const ym = ymKey(c[iM]); const cnt = smartInt(c[iC]);
      return ym ? { date:new Date(ym + "-01"), count:cnt } : null;
    }).filter(Boolean);

    setBadge("b-monthly", `loaded ${values.length} rows from ${url}`);

    const spec = {
      $schema:'https://vega.github.io/schema/vega-lite/v5.json',
      width:560, height:340,
      data:{ values },
      layer:[
        { mark:{ type:'area', opacity:0.15, color:varBlue() },
          encoding:{ x:{field:'date',type:'temporal',title:'Month'},
                     y:{field:'count',type:'quantitative',title:'Sightings'} } },
        { mark:{ type:'line', color:varBlue() },
          encoding:{ x:{field:'date',type:'temporal'},
                     y:{field:'count',type:'quantitative'} } },
        { mark:{ type:'point', color:varBlue() },
          encoding:{ x:{field:'date',type:'temporal'},
                     y:{field:'count',type:'quantitative'},
                     tooltip:[{field:'date',type:'temporal'},{field:'count',type:'quantitative'}] } }
      ],
      config:{ background:null }
    };
    await vegaEmbed('#monthly', spec, {actions:false});
  }catch(e){
    console.error('Monthly error:', e);
    setBadge('b-monthly','failed to load', false);
  }
}

/* ---------- 4) HOURLY donut ---------- */
async function renderHourly(){
  try{
    const {url,text} = await fetchFirst(PATHS.hourly);
    const rows = text.trim().split(/\r?\n/).map(r=>r.split(";"));
    const head = rows.shift().map(h=>h.trim().toLowerCase());
    const iH=head.indexOf("hour"), iC=head.indexOf("count");
    const values = rows.map(c=>({hour:+c[iH], count:smartInt(c[iC])}))
                       .filter(d=>isFinite(d.hour)&&isFinite(d.count));
    setBadge("b-hourly", `loaded ${values.length} rows from ${url}`);

    const spec = {
      $schema:'https://vega.github.io/schema/vega-lite/v5.json',
      width:560, height:340,
      data:{ values },
      transform:[{calculate:'format(datum.hour,"02")', as:'hlabel'}],
      mark:{ type:'arc', innerRadius:90, stroke:'#0b1220' },
      encoding:{
        theta:{ field:'count', type:'quantitative', stack:true, title:'Reports' },
        color:{ field:'hlabel', type:'nominal',
                legend:{title:'Hour (00–23)', orient:'bottom', columns:6, labelLimit:160} },
        tooltip:[{field:'hour',title:'Hour'},{field:'count',type:'quantitative'}]
      },
      config:{ legend:{orient:'bottom'} }
    };
    await vegaEmbed('#hourly', spec, {actions:false});
  }catch(e){
    console.error('Hourly error:', e);
    setBadge('b-hourly','failed to load', false);
  }
}

/* ---------- 5) Top cities (bar) ---------- */
async function renderCities(){
  try{
    const {url,text} = await fetchFirst(PATHS.cities);
    const rows = text.trim().split(/\r?\n/).map(r=>r.split(";"));
    const head = rows.shift().map(h=>h.trim().toLowerCase());
    const iCity=head.indexOf("city"), iC=head.indexOf("count");
    const values = rows.map(c=>({city:(c[iCity]||'').toLowerCase().trim(), count:smartInt(c[iC])}))
                       .filter(r=>r.city && isFinite(r.count))
                       .sort((a,b)=>b.count-a.count).slice(0,30);
    setBadge("b-cities", `loaded ${values.length} rows from ${url}`);

    const spec = {
      $schema:'https://vega.github.io/schema/vega-lite/v5.json',
      width:560, height:340,
      data:{ values },
      mark:{ type:'bar', tooltip:true },
      encoding:{
        y:{ field:'city', type:'nominal', sort:'-x', title:'City' },
        x:{ field:'count', type:'quantitative', title:'Reports' }
      },
      config:{ background:null }
    };
    await vegaEmbed('#cities', spec, {actions:false});
  }catch(e){
    console.error('Cities error:', e);
    setBadge('b-cities','failed to load', false);
  }
}

/* ---------- 6) Shapes (bar) ---------- */
async function renderShapes(){
  try{
    const {url,text} = await fetchFirst(PATHS.shapes);
    const rows = text.trim().split(/\r?\n/).map(r=>r.split(";"));
    const head = rows.shift().map(h=>h.trim().toLowerCase());
    const iS=head.indexOf("shape"), iC=head.indexOf("count");
    const values = rows.map(c=>({shape:(c[iS]||'').toLowerCase().trim(), count:smartInt(c[iC])}))
                       .filter(r=>r.shape && isFinite(r.count));
    setBadge("b-shapes", `loaded ${values.length} rows from ${url}`);

    const spec = {
      $schema:'https://vega.github.io/schema/vega-lite/v5.json',
      width:560, height:340,
      data:{ values },
      mark:{ type:'bar', tooltip:true },
      encoding:{
        y:{ field:'shape', type:'nominal', sort:'-x', title:'Shape' },
        x:{ field:'count', type:'quantitative', title:'Reports' }
      },
      config:{ background:null }
    };
    await vegaEmbed('#shapes', spec, {actions:false});
  }catch(e){
    console.error('Shapes error:', e);
    setBadge('b-shapes','failed to load', false);
  }
}

// tiny helper to reuse brand color in spec
function varBlue(){ return getComputedStyle(document.documentElement).getPropertyValue('--blue').trim() || '#38bdf8'; }

// run all
Promise.all([
  renderMap(),
  renderHeat(),
  renderMonthly(),
  renderHourly(),
  renderCities(),
  renderShapes()
]);
</script>
</body>
</html>
